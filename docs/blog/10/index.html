
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="iem7"><![endif]-->
<!--[if lt IE 9]><html class="lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html lang="en"><!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <title>Jake McCrary</title>
    <meta name="author" content="Jake McCrary">

    
    
    
    

    <meta itemprop="name" content="Jake McCrary" />
    <meta itemprop="description" content=" This past fall I took part in Stanford&rsquo;s online learning experiment. For those of you who are not aware, Stanford gave anyone with Internet &hellip;" />

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@jakemcc" />
    <meta name="twitter:title" content="Jake McCrary" />
    <meta name="twitter:description" content=" This past fall I took part in Stanford&rsquo;s online learning experiment. For those of you who are not aware, Stanford gave anyone with Internet &hellip;" />
    <meta name="twitter:creator" content="@jakemcc" />
    <meta name="twitter:image" content="https://jakemccrary.com/images/jake-surprised-eyes-brighter.jpg" />

    <!-- Open Graph data -->
    <meta property="og:site_name" content="The Blog of Jake McCrary" />
    <meta property="og:url" content="https://jakemccrary.com/blog/10/" />
    <meta property="og:title" content="Jake McCrary" />
    <meta property="og:description" content=" This past fall I took part in Stanford&rsquo;s online learning experiment. For those of you who are not aware, Stanford gave anyone with Internet &hellip;" />
    <meta property="og:image" content="https://jakemccrary.com/images/jake-surprised-eyes-brighter.jpg" />
    
    

    <meta name="description" content=" This past fall I took part in Stanford&rsquo;s online learning experiment. For those of you who are not aware, Stanford gave anyone with Internet &hellip;">

    

    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://jakemccrary.com/blog/10/">
    <link href="/favicon.png" rel="icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="alternate" title="Jake McCrary" type="application/atom+xml">
    <link href="https://jakemccrary.com/feed.json" rel="alternate" title="Jake McCrary" type="application/json">

    <!-- iOS scaling bug fix Rewritten version By @mathias, @cheeaun and @jdalton Source url: https://gist.github.com/901295 -->
    <script type="text/javascript">
     (function(doc) {
       var addEvent = 'addEventListener',
           type = 'gesturestart',
           qsa = 'querySelectorAll',
           scales = [1, 1],
           meta = qsa in doc ? doc[qsa]('meta[name=viewport]') : [];
       function fix() {
         meta.content = 'width=device-width,minimum-scale=' + scales[0] + ',maximum-scale=' + scales[1];
         doc.removeEventListener(type, fix, true);
       }
       if ((meta = meta[meta.length - 1]) && addEvent in doc) {
         fix();
         scales = [0.25, 1.6];
         doc[addEvent](type, fix, true);
       }
     }(document));
    </script>
    
<script>
 var origin = window.location.origin;
 if (!origin) {
   origin = window.location.protocol + '//' + window.location.hostname + (window.location.port ? (':' + window.location.port) : '');
 }
 if (origin.indexOf('localhost') === -1) {
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

   ga('create', 'UA-19834208-2', 'auto');
   ga('send', 'pageview');
 }
</script>


  </head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jake McCrary</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul role=main-navigation>
  <li><a href="/">Articles</a></li>
  <li><a href="/adventures/">Adventures</a></li>
  <li><a href="/about.html">About</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>

  <form action="https://google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="sitesearch" value="jakemccrary.com">
      <input class="search" type="text" name="q" placeholder="Search"/>
    </fieldset>
  </form>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/29/reflections-on-stanfords-online-class-experiment/">Reflections on Stanford's online class experiment</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-12-29T18:42:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>6:42 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>This past fall I took part in Stanford&rsquo;s online learning experiment. For those of you who are not aware, Stanford gave anyone with Internet access the opportunity to enroll in three different online courses. This was free of charge, not even books were required. Each was an introductory level class, with the three subjects being <a href="http://ai-class.com">artificial intelligence</a>, <a href="http://ml-class.org">machine learning</a>, and <a href="http://db-class.org">databases</a> (links may die as offered classes change). As far as I know, this was the first time that lecture videos have been paired with scheduled homework, quizzes, and programming assignments at this scale. I only vaguely remember numbers for the AI (artificial intelligence) and ML (machine learning) classes but I believe before classes began there were greater than 100,000 students enrolled apiece. The number of active students was approximately a third of the enrolled number. Even still, this is teaching at an unheard of scale.</p>

<p>I enrolled in both the AI and ML courses. Enrolling in two was more work, but I&rsquo;m glad I did it. The classes followed slightly different formats and taking both provided a perspective in what style worked better for me.</p>

<h3>AI Class</h3>

<p>The AI class had video lectures, in video quizzes, homework, and two exams. The videos for this class were short. Each video lasted approximately one to four minutes. This was a nice length as you could easily go back and pick out specific topics to re-watch without jumping around a longer video. The videos showed the professor hand writing notes on pieces of paper. This style made it seem like you were receiving one-on-one tutoring.</p>

<p>At the end of some of the videos a quiz question was asked. These questions did not count towards your final grade. They existed to help you think and learn about the material as it was being presented.</p>

<p>The homework usually consisted of a fewer than 10 questions. You had until the due date to submit or change your answers. You did not get any feedback on the homework until it was graded.</p>

<p>For both of the exams you had about three days to finish the 15 or so questions that were asked.</p>

<h3>ML Class</h3>

<p>The ML class had video lectures, in video quizzes, homework, and programming assignments. In contrast to the AI class, the ML video lectures were usually five to thirteen minutes long. This made it harder to re-watch specific parts as you had to jump around the video to find different topics. On the plus side, the ML videos could be easily downloaded and watched on any device (you could not do this with the AI lectures). The ML videos also had controls for speeding up playback. I watched the vast majority of the videos at 1.5 times the normal speed.</p>

<p>The video questions for the ML class were similar to the AI class in that they didn&rsquo;t count towards a final grade and there was usually a max of one per video. Because of the fewer number of videos, there were fewer quizzes than in the AI class. More quizzes would be good, as it forces the student to think instead of simply zoning out while watching the lectures.</p>

<p>The homework in the ML class was different from the AI class in a couple of ways. The largest difference was that you received feedback immediately when you submitted your answers. You were allowed to attempt the homework as often as you liked and your highest score became your score for that assignment. The questions were somewhat different between different attempts to minimize memorization of answers. There was also a minimum waiting period of ten minutes between attempts, but in order to reduce reliance on simply remembering previous attempts I usually waited a few hours to a day between attempts.</p>

<p>The ML class had programming assignments. In these exercises you filled in some <a href="http://www.gnu.org/software/octave/">Octave</a> code to implement an aspect of machine learning. These exercises where great. Most of the time they made you think about the techniques you were learning that week. It was also nice to get some hands-on experience solving sample machine learning problems. It was rewarding watching my simple spam filter flag email as spam. The programming exercises were best when they weren&rsquo;t simply a task in translating math to code.</p>

<h3>Thoughts on the differences</h3>

<p>I enjoyed the ML class homework style, instant feedback upon submission, better than the AI because it provided a quicker feedback cycle. Instead of submitting homework answers and waiting to review mistakes you were able to review instantly. I found this, and being able to repeat homework, to be more effective for learning than the single shot style of the AI class.</p>

<p>I preferred the shortness of the AI lectures. It allowed for easier repetition of lectures and provided more opportunities for quizzes. I also preferred the handwritten style of the AI lectures. The ML lectures felt like I was back in a classroom watching a professor go through some power point slides, adding handwritten notes as the lecture progressed. That isn&rsquo;t very engaging. The one-on-one style of the AI lectures was more engaging.</p>

<p>I enjoyed both the programming exercises of ML class and the exams in the AI class. Both added an interesting way of learning to their respective class.</p>

<h3>Recommendations</h3>

<p>If I were designing a course for myself, I found the short videos with many quiz questions style of lecturing to be the more effective style. I would offer homework in a fashion similar to the ML class. Submit as many times as you want, but with a minimum time between submissions. I would up that time to be at least one hour to minimize memorization of answers. My ideal class would also have both programming exercises and exams.</p>

<p>Both classes had some student run question and answer boards (similar to <a href="http://stackoverflow.com">stackoverflow</a>). This was alright but I would look into adding a type of forum that is more suited towards discussions. A Q&amp;A style board is not a great environment for having a discussion that is ordered by time. I think normal forums style with replies ordered by time would be effective and worth an experiment.</p>

<h3>Conclusion</h3>

<p>I greatly enjoyed taking these two Stanford classes. I think online lectures and homework were an extremely effective way of delivering information and reinforcing learning. I found taking these two classes to be a manageable amount of work. I did pretty much stop reading books while taking these classes and instead focused on watching lectures and doing homework. Had I only taken one class or spent breaks at work watching videos, I think I would have been able to maintain my other activities while taking these classes.</p>

<p>There are quite a few classes being offered at Stanford that start in the near future. Scroll to the bottom of <a href="http://www.ml-class.org/course/auth/index">this</a> page to take a look at what Stanford is offering starting in January. I would highly recommend taking a class. MIT also just announced <a href="http://web.mit.edu/newsoffice/2011/mitx-education-initiative-1219.html">MITx</a>. I haven&rsquo;t heard a ton of information about it, but it sounds similar and I look forward to its launch.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/12/16/continuous-testing-with-clojure-and-expectations/">Continuous testing with Clojure and expectations</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-12-16T09:30:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>9:30 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve recently started using <a href="http://jayfields.com/">Jay Fields'</a> Clojure testing library, <a href="https://github.com/jaycfields/expectations"><code>expectations</code></a>. I&rsquo;m not going to explain <code>expectations</code>, Jay already did a great job on his <a href="http://blog.jayfields.com/2011/11/clojure-expectations-introduction.html">blog</a>, but I will quote its <a href="https://github.com/jaycfields/expectations">Github</a> page.</p>

<blockquote><p>expectations is a minimalist&rsquo;s testing framework</p></blockquote>

<p>The above quote is absolutely true, which is one of the major reasons I&rsquo;m liking <code>expectations</code>. It hasn&rsquo;t been all sunshine though, when I first started using it I had a major problem. It slowed down my usual Clojure workflow.</p>

<p>Up until this point I had stuck to using <code>clojure.test</code>. Combined with emacs, slime, swank, and <code>clojure-test-mode</code> I found the time between making a change to code and running tests to be minimal.</p>

<p>When I switched to <code>expectations</code> the time it took between making a code change and running tests increased. With <code>expectations</code> I couldn&rsquo;t reevaluate my buffer to get the new tests in my repl environment. Doing so caused the new tests to be there along with the old tests. This meant I needed to switch to the command line to run my tests. This caused me to incur the startup costs of the jvm simply to run my expectations (tests). This was a huge cost compared to what I was used to before.</p>

<h2>Introducing <code>lein-autoexpect</code></h2>

<p>To fix my problem I wrote <a href="https://github.com/jakemcc/lein-autoexpect"><code>lein-autoexpect</code></a>. <code>lein-autoexpect</code> is a <a href="https://github.com/technomancy/leiningen/"><code>Leiningen</code></a> plugin that monitors a project&rsquo;s source and test directory and when a Clojure file changes it reloads the affected namespaces and runs all the expectations. Using this plugin my turn around time from modifying code to running all of my expectations is practically nothing. Without the cost of the jvm startup there is practically no time wasted between when code is saved and tests are run.</p>

<p>To use <code>lein-autoexpect</code> simply add <code>[lein-autoexpect "0.0.2"]</code> to your <code>project.clj</code> file and fetch the dependency. Then at the command line run <code>lein autoexpect</code>. You&rsquo;ll see your tests run and then it will just hang there, eagerly waiting for code to change.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein autoexpect
</span><span class='line'>*********************************************
</span><span class='line'>*************** Running tests ***************
</span><span class='line'>Ran <span class="m">3</span> tests containing <span class="m">3</span> assertions in <span class="m">16</span> msecs
</span><span class='line'><span class="m">0</span> failures, <span class="m">0</span> errors.
</span></code></pre></td></tr></table></div></figure>


<p>Next time you end up saving you&rsquo;ll see your tests run again and the following example output appears.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>*********************************************
</span><span class='line'>*************** Running tests ***************
</span><span class='line'>Ran <span class="m">4</span> tests containing <span class="m">4</span> assertions in <span class="m">3</span> msecs
</span><span class='line'><span class="m">0</span> failures, <span class="m">0</span> errors.
</span></code></pre></td></tr></table></div></figure>


<p><code>lein-autoexpect</code> tries to clearly delimit each test session with the banner made of <code>*</code>. This helps keep different runs separate when scrolling through your terminal.</p>

<p>This style of testing is called <a href="http://blog.objectmentor.com/articles/2007/09/20/continuous-testing-explained">continuous testing</a>. If you haven&rsquo;t tried it, I would highly recommend giving it a shot. Even just using it for the last few days changed how I think testing should be done.</p>

<p>Source can be found on <a href="https://github.com/jakemcc/lein-autoexpect">Github</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/07/25/utilities-i-like-autojump/">Utilities I like: autojump</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-07-25T00:00:00-05:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/joelthelion/autojump">autojump</a> is a nifty command line tool that enables quicker jumping between directories. I&rsquo;ve been using it for a few months now and miss it when I work other machines.</p>

<p>To jump to a directory you type <code>j SUBSTRING_OF_DIR</code>. Example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">pwd</span>
</span><span class='line'>/Users/jmccrary
</span><span class='line'><span class="nv">$ </span>j jake
</span><span class='line'>/Users/jmccrary/src/github/jakemcc/jakemccrary.com
</span><span class='line'><span class="nv">$ </span><span class="nb">pwd</span>
</span><span class='line'>/Users/jmccrary/src/github/jakemcc/jakemccrary.com
</span></code></pre></td></tr></table></div></figure>


<p>Above I jumped from my home directory to the root of this website&rsquo;s code. Being able to jump between directories by just remembering a name (or part of a name) is great. This frees me from having to remember full paths or set up aliases.</p>

<p>autojump works by keeping a database of &ldquo;time&rdquo; spent in directories and jumps to the most frequently visited one that match <code>SUBSTRING_OF_DIR</code>. If you are curious as to what that database looks like the tool <code>jumpstat</code> will give you a view.</p>

<p>I used to set up aliases for jumping between projects but now that I&rsquo;ve trained myself to use autojump I don&rsquo;t think I&rsquo;ll ever go back. Not having to do any extra work besides simply entering the root directory of new projects to setup efficient directory movement is great. I think that if you give it a shot for a while you&rsquo;ll find the same benefits.</p>

<p>If you are on a Mac and use <a href="https://github.com/mxcl/homebrew">homebrew</a> you can install by doing <code>brew install autojump</code>. For other platforms check out the <a href="https://github.com/joelthelion/autojump">github</a> page.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/06/28/a-simple-way-of-testing-disconnect-logic/">A simple way of testing disconnect logic</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-06-28T00:00:00-05:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m guessing that software you write connects to some other server. I&rsquo;m also guessing that how it handles disconnects is tested (if ever tested) by either killing the process it connects to or by pulling out your network cable. I recently stumbled across a nifty Linux command line tool that makes causing disconnects significantly easier.</p>

<p>This tool is <a href="http://linux.die.net/man/8/tcpkill">tcpkill</a>. To use <code>tcpkill</code> you specify an interface and a <a href="http://linux.die.net/man/8/tcpdump">tcpdump</a> style filter and it kills traffic on that interface that matches the filter.</p>

<p>For example, if your application has a connection to 192.168.1.130, then to force a disconnect you would execute <code>tcpkill -i eth0 host 192.168.1.130</code>.</p>

<p><code>tcpkill</code> can be used for more than forcing disconnects. It can also be used as a simple website filter. If <a href="http://stackoverflow.com">Stack Overflow</a> wastes too much of your time then you could simply leave <code>tcpkill -i eth0 host stackoverflow.com</code> running and enjoy your increased productivity.</p>

<p><code>tcpkill</code> is a pretty useful tool. If you want to install it in Ubuntu it is found in the dsniff package (<code>apt-get install dsniff</code>).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/12/command-line-arguments-in-clojure/">Command line arguments in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-04-12T20:00:00-05:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>8:00 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p><em>This post is now out of date. The library recommended by this post is now a contrib library. Check out <a href="https://github.com/clojure/tools.cli">tools.cli</a> for great documentation about handling command line arguments in Clojure.</em></p>

<hr />

<p>Write enough Clojure and eventually you will need to handle command line arguments. There are numerous ways of doing this. Keep reading for a brief introduction to three.</p>

<h3>Using built-in features</h3>

<p>There exists a sequence named <code>*command-line-args*</code> which contains the arguments to your application. Using it is simple, it is just a sequence after all, and it is always available to you. No need to pull in external dependencies that others may not be familiar with.</p>

<p>This simplicity is also a downside. Because only a sequence is provided for you it is up to you to actually figure out the arguments. If you want to do any sort of verification that certain arguments are supplied you write the code that does the verifying. If you want to move away from positional arguments to using command line flags once again it is up to you to write it.</p>

<p>Because of the amount of code required to do any sort of advanced argument handling I tend to use <code>*command-line-args*</code> only for applications that take a single type of argument, for example a file path, and require one or more of this type of argument.</p>

<h3>Setup for next two sections</h3>

<p>For the next two sections I&rsquo;m using version 1.5.0 of Leiningen and the specified versions of libraries as stated in the below <code>project.clj</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defproject </span><span class="nv">blogpost</span> <span class="s">&quot;1.0.0-SNAPSHOT&quot;</span>
</span><span class='line'>  <span class="ss">:dependencies</span> <span class="p">[[</span><span class="nv">org.clojure/clojure</span> <span class="s">&quot;1.2.0&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">org.clojure/clojure-contrib</span> <span class="s">&quot;1.2.0&quot;</span><span class="p">]</span>
</span><span class='line'>                 <span class="p">[</span><span class="nv">clargon</span> <span class="s">&quot;1.0.0&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:dev-dependencies</span> <span class="p">[[</span><span class="nv">swank-clojure</span> <span class="s">&quot;1.2.1&quot;</span><span class="p">]]</span>
</span><span class='line'>  <span class="ss">:run-aliases</span> <span class="p">{</span><span class="ss">:clargon</span> <span class="nv">clargon-example</span>
</span><span class='line'>                <span class="ss">:cc</span> <span class="nv">command-line-example</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m using <code>lein run</code> to run the examples. <code>lein run :cc</code> runs the clojure.contrib example. Likewise, running <code>lein run :clargon</code> will run the clargon examples. Both of these commands can be followed by additional arguments that get passed to the application.</p>

<h3>Using clojure.contrib.command-line</h3>

<p>The next step after using <code>*command-line-args*</code> is to use the library <code>clojure.contrib.command-line</code>. This library provides the function <code>with-command-line</code> that allows you specify requirements and then handles the parsing of the command line arguments for you.</p>

<p>Positives of using <code>clojure.contrib.command-line</code>:
* Part of <code>clojure.contrib</code>. Probably extremely low friction to start using it.
* No longer need to write your own command line parsing code.
* Responds to <code>-h</code> and <code>--help</code>.</p>

<p>A negative of using <code>clojure.contrib.command-line</code> is that the documentation is pretty sparse. This can lead to some fumbling around as you learn how to use it. Another downside is that there isn&rsquo;t a way of specifying whether an argument is required or optional. This means you must manually check for required arguments and give appropriate error messages to the user.</p>

<p>Below is an example of using <code>clojure.contrib.command-line</code>. It specifies a few different arguments. The <code>--cow</code> argument has a default value of &ldquo;cow&rdquo;. <code>--chicken</code> has no default value, if it is left unspecified it will be <code>nil</code>. The line with <code>milk?</code> specifies a boolean value. If <code>--milk</code> (or <code>-m</code> because of the <code>m?</code> specification) is specified at the command line then <code>milk?</code> will be true. <code>extras</code> will collect any additional arguments.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">command-line-example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.contrib.command-line</span> <span class="ss">:as</span> <span class="nv">ccl</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">ccl/with-command-line</span> <span class="nv">args</span>
</span><span class='line'>    <span class="s">&quot;Command line demo&quot;</span>
</span><span class='line'>    <span class="p">[[</span><span class="nv">cow</span> <span class="s">&quot;This is the cows name&quot;</span> <span class="s">&quot;cow&quot;</span><span class="p">]</span>
</span><span class='line'>     <span class="p">[</span><span class="nv">chicken</span> <span class="s">&quot;This specifies the chickens name&quot;</span><span class="p">]</span>
</span><span class='line'>     <span class="p">[</span><span class="nv">milk?</span> <span class="nv">m?</span> <span class="s">&quot;Should you milk the cow?&quot;</span><span class="p">]</span>
</span><span class='line'>     <span class="nv">extras</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;cow&#39;s name: &quot;</span> <span class="nv">cow</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;chicken&#39;s name: &quot;</span> <span class="nv">chicken</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;milk?: &quot;</span> <span class="nv">milk?</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;extra args: &quot;</span> <span class="nv">extras</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is an example of calling that <code>-main</code> function from the repl.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lein run :cc --cow Herb --milk other args
</span><span class='line'>cow<span class="s1">&#39;s name:  Herb</span>
</span><span class='line'><span class="s1">chicken&#39;</span>s name:  nil
</span><span class='line'>milk?:  <span class="nb">true</span>
</span><span class='line'>extra args:  <span class="o">[</span>other args<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using some other library</h3>

<p>Another option is to use some library that isn&rsquo;t found in <code>clojure.contrib</code>. One example of this is <a href="https://github.com/gar3thjon3s/clargon">clargon</a>. Clargon is a library that <a href="http://blog.gaz-jones.com/">Gaz Jones</a> (his blog post <a href="http://blog.gaz-jones.com/post/2528825514/command-line-applications-in-clojure">here</a>) wrote. The documentation (both in his blog post and through the github page and tests) is the primary reason I started using it.</p>

<p>Pros of clargon:
* Great documentation. Makes it quick to get started.
* Can specify functions to transform arguments prior to gaining access to them
* You specify if an argument is required or optional.
* Responds to <code>-h</code> and <code>--help</code>.</p>

<p>One potential negative of using clargon is that it isn&rsquo;t a <code>clojure.contrib</code> library. This means there is slightly more friction to start using it on your project as, unlike <code>clojure.contrib</code>, you are probably not already depending on it.</p>

<p>Below is an example similar to the above <code>clojure.contrib.command-line</code> example. One important difference is that some arguments are now specified as either required or optional. If a required argument is not specified then an error is printed and execution stops.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">clargon-example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clargon.core</span> <span class="ss">:as</span> <span class="nv">c</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">opts</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">c/clargon</span>
</span><span class='line'>         <span class="nv">args</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">c/optional</span> <span class="p">[</span><span class="s">&quot;--cow&quot;</span> <span class="s">&quot;Specify the cow&#39;s name&quot;</span> <span class="ss">:default</span> <span class="s">&quot;cow&quot;</span><span class="p">])</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">c/required</span> <span class="p">[</span><span class="s">&quot;--chicken&quot;</span> <span class="s">&quot;Chicken&#39;s name&quot;</span><span class="p">])</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">c/optional</span> <span class="p">[</span><span class="s">&quot;-m?&quot;</span> <span class="s">&quot;--milk?&quot;</span> <span class="s">&quot;should you milk the cow?&quot;</span><span class="p">]))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="nv">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="nv">opts</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>optional</code> and <code>required</code> both take a vector that defines the specification of a flag. Starting with the first element in that vector, each element that is a string and starts with a &lsquo;-&rsquo; is considered a potential flag for that argument. The last flag is stripped of leading &lsquo;-&rsquo; characters and is considered the name of that flag (unless a <code>:name</code> option is specified later). The name is used to look up the value of the argument in the option map that is returned by the <code>clargon</code> function. If the next element after the last flag is a string then it is considered the documentation for that flag. When clargon runs into a non-string element then it and everything after it are considered options and should be specified as key value pairs. Options that do something are <code>:default</code>, <code>:name</code>, and <code>:required</code>.</p>

<p><code>optional</code> and <code>required</code> both can take a function as a second argument. This function will be passed the argument for that flag and should return a transformed version of it. Below is an example using this functionality to specify a required flag that takes a comma separated list of files. These comma separated files are split apart and stuck into a vector.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">clargon-example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clargon.core</span> <span class="ss">:as</span> <span class="nv">c</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>
</span><span class='line'>  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">opts</span> <span class="p">(</span><span class="nf">c/clargon</span>
</span><span class='line'>              <span class="nv">args</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">c/required</span> <span class="p">[</span><span class="s">&quot;--files&quot;</span> <span class="s">&quot;Files to process&quot;</span><span class="p">]</span>
</span><span class='line'>                          <span class="o">#</span><span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nf">.split</span> <span class="nv">%</span> <span class="s">&quot;,&quot;</span><span class="p">))))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">println </span><span class="s">&quot;Parsed opts: &quot;</span> <span class="nv">opts</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is the above example being ran.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">$</span> <span class="nv">lein</span> <span class="nv">run</span> <span class="ss">:clargon</span> <span class="nv">--files</span> <span class="nv">one.txt</span>,<span class="nv">two.txt</span>,<span class="nv">three.txt</span>
</span><span class='line'><span class="nv">Parsed</span> <span class="nv">opts</span><span class="err">:</span>  <span class="p">{</span><span class="ss">:files</span> <span class="p">[</span><span class="nv">one.txt</span> <span class="nv">two.txt</span> <span class="nv">three.txt</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Clargon supports some more advanced nested argument handling that I&rsquo;m not going to go into here. If you want to know more about clargon I&rsquo;d recommend reading reading Gaz&rsquo;s <a href="http://blog.gaz-jones.com/post/2528825514/command-line-applications-in-clojure">blog post</a> and the <a href="https://github.com/gar3thjon3s/clargon">clargon</a> readme and tests.</p>

<h3>End</h3>

<p>There are many more ways to handle command line parsing in Clojure. You are not limited to any of the three above. I&rsquo;ve personally found clargon to hit all of my needs and plan on continuing to use it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/19/creating-sql-table-with-composite-key-in-clojure/">Creating a SQL table with a composite primary key in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-01-19T00:00:00-06:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I was interacting with a SQL database using Clojure and needed to create a table so I turned to <code>create-table</code> from <a href="http://clojure.github.com/clojure-contrib/sql-api.html">clojure.contrib.sql</a>. Looking at the <a href="http://clojure.github.com/clojure-contrib/sql-api.html#clojure.contrib.sql/create-table">docs</a> for <code>create-table</code> it seemed pretty straight forward. To create a table with columns <em>date</em>, <em>id</em>, <em>symbol</em>, <em>price</em>, and <em>quantity</em> you would write the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">create-table</span> <span class="s">&quot;orders&quot;</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:date</span>     <span class="s">&quot;date&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:id</span>       <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:symbol</span>   <span class="s">&quot;char(10)&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:price</span>    <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:quantity</span> <span class="s">&quot;integer&quot;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above works. I also wanted to specify that columns <em>date</em> and <em>id</em> to form a composite primary key. I wasn&rsquo;t sure how to specify a composite primary key with <code>create-table</code> and ended up diving into its <a href="https://github.com/clojure/clojure-contrib/blob/b8d2743d3a89e13fc9deb2844ca2167b34aaa9b6/src/main/clojure/clojure/contrib/sql.clj#L103">code</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-table</span>
</span><span class='line'>  <span class="s">&quot;Creates a table on the open database connection given a table name and</span>
</span><span class='line'><span class="s">  specs. Each spec is either a column spec: a vector containing a column</span>
</span><span class='line'><span class="s">  name and optionally a type and other constraints, or a table-level</span>
</span><span class='line'><span class="s">  constraint: a vector containing words that express the constraint. All</span>
</span><span class='line'><span class="s">  words used to describe the table may be supplied as strings or keywords.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="o">&amp;</span> <span class="nv">specs</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-commands</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;CREATE TABLE %s (%s)&quot;</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">as-str</span> <span class="nv">name</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">apply str </span>
</span><span class='line'>             <span class="p">(</span><span class="nb">map </span><span class="nv">as-str</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">apply concat </span>
</span><span class='line'>               <span class="p">(</span><span class="nf">interpose</span> <span class="p">[</span><span class="s">&quot;, &quot;</span><span class="p">]</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">interpose</span> <span class="s">&quot; &quot;</span><span class="p">)</span> <span class="nv">specs</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at <code>create-table</code> we can see it creates a SQL statement which is then executed by <code>do-commands</code>. In order to have a composite key we need <code>do-commands</code> to execute a SQL statement that looks similar to below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">track</span><span class="p">(</span>
</span><span class='line'>  <span class="nb">date</span> <span class="nb">date</span><span class="p">,</span>
</span><span class='line'>  <span class="n">id</span> <span class="nb">integer</span><span class="p">,</span>
</span><span class='line'>  <span class="n">symbol</span> <span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</span><span class='line'>  <span class="n">price</span> <span class="nb">integer</span><span class="p">,</span>
</span><span class='line'>  <span class="n">quantity</span> <span class="nb">integer</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s break down <code>create-table</code> to figure out what we need to pass it to make <code>do-commands</code> run the above statement. The code for <code>create-table</code> is repeated below with comments pointing out what step lines up the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-table</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="o">&amp;</span> <span class="nv">specs</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-commands</span>                                              <span class="c1">; step 7</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;CREATE TABLE %s (%s)&quot;</span>                           <span class="c1">; step 6</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">as-str</span> <span class="nv">name</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">apply str </span>                                      <span class="c1">; step 5</span>
</span><span class='line'>             <span class="p">(</span><span class="nb">map </span><span class="nv">as-str</span>                                    <span class="c1">; step 4</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">apply concat </span>                                <span class="c1">; step 3</span>
</span><span class='line'>               <span class="p">(</span><span class="nf">interpose</span> <span class="p">[</span><span class="s">&quot;, &quot;</span><span class="p">]</span>                            <span class="c1">; step 2</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">interpose</span> <span class="s">&quot; &quot;</span><span class="p">)</span> <span class="nv">specs</span><span class="p">))))))))</span>  <span class="c1">; step 1</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>First <code>create-table</code> takes the sequences in <code>specs</code> and puts a space between each element in each sequence.</li>
<li>The result of step 1 then has a vector containing a comma and a space interposed between each element of it.</li>
<li><code>concat</code> combined with <code>apply</code> is used to combine each element of the result of step 2 into a single sequence.</li>
<li><code>as-str</code> (from <a href="http://clojure.github.com/clojure-contrib/string-api.html#clojure.contrib.string/as-str">c.c.string</a>) is mapped over the result of step 3 to make sure every element is a string.</li>
<li><code>str</code> is used to make one string out of the sequence of strings from step 4.</li>
<li><code>format</code> is used to substitute in <code>name</code> and the result of step 5 to create the SQL statement.</li>
<li><code>do-commands</code> executes the statement created in step 6.</li>
</ol>


<p>Knowing how <code>create-table</code> works now allows us to specify the arguments that will create the orders table with the composite primary key of <em>date</em> and <em>id</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">create-table</span> <span class="s">&quot;orders&quot;</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:date</span>     <span class="s">&quot;date&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:id</span>       <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:symbol</span>   <span class="s">&quot;char(10)&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:price</span>    <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:quantity</span> <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="s">&quot;PRIMARY KEY&quot;</span> <span class="s">&quot;(date, id)&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/18/generating-test-cases-in-clojure/">Generating test cases in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-01-18T00:00:00-06:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I was writing some data mining Clojure code which needed to parse a log file and do some transforms of the data. Some of the transforms were dependent on data found across multiple lines. There was no ordering or proximity guarantees to these lines.</p>

<p>This required the code to handle a variety of situations. After writing a couple simple tests and getting those passing I wanted to more extensively test my solution. I was lazy though and did not want to hand code all of the potential orderings.  Enter <code>permutations</code>.</p>

<p><code>permutations</code> is a function out of <a href="http://clojure.github.com/clojure-contrib/combinatorics-api.html">clojure.contrib.combinatorics</a>. As the name suggests, you give it a collection and it returns a lazy sequence containing all the different permutations of the elements in that collection. An example is below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">user&gt;</span><span class="p">(</span><span class="kd">ns </span><span class="nv">generate</span><span class="p">)</span>
</span><span class='line'><span class="nv">generate&gt;</span><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.contrib.combinatorics</span> <span class="ss">:only</span> <span class="p">[</span><span class="nv">permutations</span><span class="p">]])</span>
</span><span class='line'><span class="nv">nil</span>
</span><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">permutations</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span> <span class="ss">:c</span><span class="p">])</span>
</span><span class='line'><span class="p">((</span><span class="ss">:a</span> <span class="ss">:b</span> <span class="ss">:c</span><span class="p">)</span> <span class="p">(</span><span class="ss">:a</span> <span class="ss">:c</span> <span class="ss">:b</span><span class="p">)</span> <span class="p">(</span><span class="ss">:b</span> <span class="ss">:a</span> <span class="ss">:c</span><span class="p">)</span> <span class="p">(</span><span class="ss">:b</span> <span class="ss">:c</span> <span class="ss">:a</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c</span> <span class="ss">:a</span> <span class="ss">:b</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c</span> <span class="ss">:b</span> <span class="ss">:a</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can already see where this is going. I was able to use <code>permutations</code> to generate all the potential different orderings of the input. This saved me the trouble of having to do that by hand.</p>

<p>One difficulty of generating test inputs pragmatically is telling what sort of inputs caused it to fail. To get around this I used the rarely used (at least in code I&rsquo;m working on) second argument of <a href="http://clojure.github.com/clojure/clojure.test-api.html#clojure.test/is">clojure.test&rsquo;s</a> <code>is</code>. This second argument is a message that prints on a failure.</p>

<p>Below is a contrived example of using <code>permutations</code> to test an obviously wrong <code>silly-add</code> function. <code>silly-add</code> is defined below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="kd">defn </span><span class="nv">silly-add</span>
</span><span class='line'>              <span class="p">[</span><span class="nv">x</span> <span class="o">&amp;</span> <span class="nv">xs</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">x</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">(</span><span class="nb">apply + </span><span class="mi">40</span> <span class="nv">xs</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">(</span><span class="nb">apply + </span><span class="nv">x</span> <span class="nv">xs</span><span class="p">)))</span>
</span><span class='line'><span class="o">#</span><span class="ss">&#39;generate/silly-add</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is a test that uses <code>permutations</code> to exercise <code>silly-add</code> with all the potential orderings three input numbers. Note that it takes advantage of the second argument to <code>is</code>. Without this we would not know what input caused the failure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;clojure.test</span><span class="p">)</span>
</span><span class='line'><span class="nv">nil</span>
</span><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">deftest</span> <span class="nv">generate-some-tests</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">input</span> <span class="p">(</span><span class="nf">permutations</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">9</span><span class="p">])]</span>
</span><span class='line'>                   <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">silly-add</span> <span class="nv">input</span><span class="p">))</span>
</span><span class='line'>                       <span class="p">(</span><span class="nb">str </span><span class="s">&quot;Failed on input: &quot;</span> <span class="p">(</span><span class="nb">seq </span><span class="nv">input</span><span class="p">)))))</span>
</span><span class='line'><span class="o">#</span><span class="ss">&#39;generate/generate-some-tests</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the test we see that there is clearly an error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">run-tests</span><span class="p">)</span>
</span><span class='line'><span class="nv">Testing</span> <span class="nv">generate</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FAIL</span> <span class="nv">in</span> <span class="p">(</span><span class="nf">generate-some-tests</span><span class="p">)</span> <span class="p">(</span><span class="nf">NO_SOURCE_FILE</span><span class="ss">:1</span><span class="p">)</span>
</span><span class='line'><span class="nv">Failed</span> <span class="nv">on</span> <span class="nv">input</span><span class="err">:</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="nv">expected</span><span class="err">:</span> <span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">silly-add</span> <span class="nv">input</span><span class="p">))</span>
</span><span class='line'>  <span class="nv">actual</span><span class="err">:</span> <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="mi">50</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FAIL</span> <span class="nv">in</span> <span class="p">(</span><span class="nf">generate-some-tests</span><span class="p">)</span> <span class="p">(</span><span class="nf">NO_SOURCE_FILE</span><span class="ss">:1</span><span class="p">)</span>
</span><span class='line'><span class="nv">Failed</span> <span class="nv">on</span> <span class="nv">input</span><span class="err">:</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">9</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">expected</span><span class="err">:</span> <span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">silly-add</span> <span class="nv">input</span><span class="p">))</span>
</span><span class='line'>  <span class="nv">actual</span><span class="err">:</span> <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="mi">50</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>permutations</code> saved me a bit of time and let me test some situations that I otherwise would not have tested. This actually exposed a subtle bug in my code. Hopefully it can do the same for you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/07/quickily-starting-a-powerful-clojure-repl/">Quickly starting a powerful Clojure REPL</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-12-07T00:00:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I often find myself browsing the Internet and then suddenly I want to have a Clojure REPL at my fingertips. As I&rsquo;ve become better with emacs and <a href="http://www.emacswiki.org/ParEdit">paredit</a> I&rsquo;ve become dependent on the powerful editing this combo affords. The rest of this post details how I changed my five step process into a two step process. It does not explain basic emacs/slime setup but rather explains how I cut a few steps out of a suboptimal workflow for getting a powerful Clojure REPL up and running in emacs.</p>

<p>My previous workflow was the following:</p>

<ol>
<li>Open a terminal</li>
<li>Change to the root of Clojure project where I use <a href="https://github.com/technomancy/leiningen">Leiningen</a> and have swank-clojure as a dependency.</li>
<li>Run the command <code>lein swank</code></li>
<li>Start emacs</li>
<li>Run <code>M-x slime-connect</code></li>
</ol>


<p>This five step process was terrible. From me seeing something interesting to try to having a REPL open took too much time.</p>

<p>Today I changed my process so it on takes two steps. They are:</p>

<ol>
<li>Start emacs</li>
<li>Run <code>M-x clojure-swank</code></li>
</ol>


<p>This is a much better. I&rsquo;ll admit had a lot of room for improvement so it wasn&rsquo;t too hard to make it better. Below are the steps I took to cut three steps.</p>

<p>First, using Leiningen 1.4.0, I ran <code>lein install swank-clojure 1.3.0-SNAPSHOT</code>. This installed a script called swank-clojure into $HOME/.lein/bin. When run, this script starts a swank server waiting for connections on port 4005.</p>

<p>Next I wrote a function in <a href="http://en.wikipedia.org/wiki/Emacs_Lisp">elisp</a> that gives emacs the ability to call the newly installed swank-clojure script, wait for the swank server to start, and then connect to it. This function, <code>clojure-swank</code>, can be seen below. It creates a buffer named <code>*clojure-swank*</code>, runs the newly installed script, and captures the output in the freshly created buffer. When the &ldquo;Connection opened&rdquo; line appears <code>slime-connect</code> is called, connecting emacs to the freshly started swank server. After this we are at the REPL with all the advantages that emacs and paredit give us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='cl'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">clojure-swank</span> <span class="p">()</span>
</span><span class='line'>  <span class="s">&quot;Launch swank-clojure from users homedir/.lein/bin&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">buffer</span> <span class="p">(</span><span class="nv">get-buffer-create</span> <span class="s">&quot;*clojure-swank*&quot;</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">display-buffer</span> <span class="p">(</span><span class="nv">buffer-or-name</span> <span class="k">&amp;optional</span> <span class="nv">not-this-window</span> <span class="nv">frame</span><span class="p">)</span> <span class="no">nil</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">bury-buffer</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">shell-command</span> <span class="s">&quot;~/.lein/bin/swank-clojure &amp;&quot;</span> <span class="nv">buffer</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">set-process-filter</span> <span class="p">(</span><span class="nv">get-buffer-process</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">process</span> <span class="nv">output</span><span class="p">)</span>
</span><span class='line'>                           <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;*clojure-swank*&quot;</span> <span class="p">(</span><span class="nv">insert</span> <span class="nv">output</span><span class="p">))</span>
</span><span class='line'>                           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">string-match</span> <span class="s">&quot;Connection opened on local port +\\([0-9]+\\)&quot;</span> <span class="nv">output</span><span class="p">)</span>
</span><span class='line'>                             <span class="p">(</span><span class="nv">slime-connect</span> <span class="s">&quot;localhost&quot;</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span> <span class="nv">output</span><span class="p">))</span>
</span><span class='line'>                             <span class="p">(</span><span class="nv">set-process-filter</span> <span class="nv">process</span> <span class="no">nil</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">message</span> <span class="s">&quot;Starting swank.. &quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve also written a <code>clojure-kill-swank</code> function for stopping the swank server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cl'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">clojure-kill-swank</span> <span class="p">()</span>
</span><span class='line'>  <span class="s">&quot;Kill swank process started by lein swank.&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nv">get-buffer-process</span> <span class="s">&quot;*clojure-swank*&quot;</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when</span> <span class="nv">process</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nv">slime-quit-lisp</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">timeout</span> <span class="mi">10</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">timeout</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">eql</span> <span class="ss">&#39;run</span> <span class="p">(</span><span class="nv">process-status</span> <span class="nv">process</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">sit-for</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">decf</span> <span class="nv">timeout</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nv">kill-buffer</span> <span class="s">&quot;*clojure-swank*&quot;</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both of those functions need to be added to a location where they will get defined on emacs start-up. Once this is done the powerful REPL you are used to emacs providing can be at your finger tips in practically no time at all.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/06/trampolining-through-mutual-recursion/">Trampolining through mutual recursion with Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-12-06T00:00:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>The other day I stumbled across some <a href="http://clojure.org">Clojure</a> code that used <a href="http://en.wikipedia.org/wiki/Mutual_recursion">mutual recursion</a>. Mutual recursion can be a valuable tool when solving a problem. Unfortunately because of the lack of <a href="http://en.wikipedia.org/wiki/Tail_call">tail call optimization</a> on the JVM this can be a dangerous technique when writing Clojure code. It can be easy to forget about this limitation and end up writing code that blows the stack.</p>

<p>Take the classic even/odd checking code from the <a href="http://en.wikipedia.org/wiki/Mutual_recursion">Wikipedia</a> page. If we just translate it to Clojure it will cause a <a href="http://en.wikipedia.org/wiki/Stack_overflow">stack overflow</a> error when we pass in a large number. The massive number of function calls require before returning causes too much memory to be consumed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">declare </span><span class="nv">my-odd?</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-even?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">true</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">my-odd?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-odd?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">false</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">my-even?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">my-even?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="c1">; Evaluation aborted. &lt;- this is a result of java.util.StackOverflowError</span>
</span></code></pre></td></tr></table></div></figure>


<p>Luckily since Clojure 1.0 there has been a useful function for dealing with this. <code>trampoline</code>, with minor modifications to your code, can be used to get around the lack of tail call optimizations (<a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/trampoline">docs here</a>).</p>

<p><code>trampoline</code> takes a function (and, if needed, arguments to pass into the function) and calls it. If the function returns a function then <code>trampoline</code> calls that. As long as functions are returned <code>trampoline</code> will continue calling them. When a non-function value is returned <code>trampoline</code> returns, passing through the value.</p>

<p>To make our sample code work with <code>trampoline</code> we simply change our functions to return a closure which wraps the call that was previously being executed. This just entails putting a <code>#</code> before the final s-exp. This takes advantage of Clojure&rsquo;s anonymous function syntax to change the function call into a closure which is returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-even?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">true</span>
</span><span class='line'>    <span class="o">#</span><span class="p">(</span><span class="nf">my-odd?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-odd?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">false</span>
</span><span class='line'>    <span class="o">#</span><span class="p">(</span><span class="nf">my-even?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>By doing this we&rsquo;ve changed how the caller interacts with <code>my-even?</code> and <code>my-odd?</code>. It now needs to be called by <code>trampoline</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">trampoline</span> <span class="nv">my-even?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="nv">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we no longer suffer from the stack overflow error.</p>

<p>I think we can still do better though, because now the caller of <code>my-even?</code> and <code>my-odd?</code> suffers since they are forced to remember to use <code>trampoline</code>. By forcing this on the caller, we&rsquo;ve pushed what should be hidden implementations details into the callers code. We can fix this by pushing the use of <code>trampoline</code> into our functions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-even?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">letfn</span> <span class="p">[(</span><span class="nf">e?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">true</span>
</span><span class='line'>                <span class="o">#</span><span class="p">(</span><span class="nf">o?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">o?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">false</span>
</span><span class='line'>                <span class="o">#</span><span class="p">(</span><span class="nf">e?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">trampoline</span> <span class="nv">e?</span> <span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-odd?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">my-even?</span> <span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">my-even?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="nv">true</span>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">my-odd?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="nv">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have the best of both worlds. Mutual recursion without the worry of a stack overflow and functions that don&rsquo;t force the caller to be aware of the implementation details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/06/06/inserting-values-into-a-nested-map-in-clojure/">Inserting values into a nested map in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-06-06'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I was writing some Clojure with a coworker and we needed to insert values into a nested map structure. Our first solution (and example of using it at the repl) looked something like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add-to-cache</span> <span class="p">[</span><span class="nv">cache</span> <span class="nv">key1</span> <span class="nv">key2</span> <span class="nv">data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">entry</span> <span class="p">(</span><span class="nb">get </span><span class="nv">cache</span> <span class="nv">key1</span> <span class="p">{})</span>
</span><span class='line'>        <span class="nv">new-entry</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">entry</span> <span class="nv">key2</span> <span class="nv">data</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assoc </span><span class="nv">cache</span> <span class="nv">key1</span> <span class="nv">new-entry</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">add-to-cache</span> <span class="p">{}</span> <span class="ss">:chicago</span> <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:sf</span> <span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:chicago</span> <span class="ss">:wickerpark</span> <span class="ss">:alex</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span><span class="ss">:sf</span> <span class="p">{</span><span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">}</span>, <span class="ss">:chicago</span> <span class="p">{</span><span class="ss">:wickerpark</span> <span class="ss">:alex</span>, <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This worked but seemed overly verbose for doing what (in our minds) should have been a simple operation. After some digging around in the docs we found the function <code>assoc-in</code>. This useful function allowed us to greatly simplify the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add-to-cache</span> <span class="p">[</span><span class="nv">cache</span> <span class="nv">key1</span> <span class="nv">key2</span> <span class="nv">data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">assoc-in</span> <span class="nv">cache</span> <span class="p">[</span><span class="nv">key1</span> <span class="nv">key2</span><span class="p">]</span> <span class="nv">data</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">add-to-cache</span> <span class="p">{}</span> <span class="ss">:chicago</span> <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:sf</span> <span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:chicago</span> <span class="ss">:wickerpark</span> <span class="ss">:alex</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span><span class="ss">:sf</span> <span class="p">{</span><span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">}</span>, <span class="ss">:chicago</span> <span class="p">{</span><span class="ss">:wickerpark</span> <span class="ss">:alex</span>, <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much simpler and easier to read. The next person to look at the code will be able to quickly skim and tell what the code is doing.</p>

<p><code>assoc-in</code> can also be used with nested associative structures like vectors.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">assoc-in</span> <span class="p">[[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span><span class="p">]]</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="ss">:z</span><span class="p">)</span>
</span><span class='line'><span class="p">[[</span><span class="mi">0</span> <span class="ss">:z</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span><span class="p">]]</span>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">assoc-in</span> <span class="p">[[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span><span class="p">]]</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">1</span><span class="p">]</span> <span class="ss">:z</span><span class="p">)</span>
</span><span class='line'><span class="p">[[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:z</span><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully this post makes searching for how to insert into nested maps slighly easier for the next person who thinks there must be a better way for doing this.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog//11">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog//9">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/05/04/how-to-be-alerted-when-a-long-running-process-finishes/">How to be automatically notified when long running processes finish</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/26/hanging-a-hangboard-using-a-doorway-pull-up-bar/">How to hang a hangboard using a doorway pull-up bar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/21/using-bash-preexec-for-monitoring-the-runtime-of-your-last-command/">Using Bash-Preexec for monitoring the runtime of your last command</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/03/16/a-retrospective-format/">A retrospective format for remote or co-located teams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/03/10/more-working-from-home-tips/">More working from home tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/25/auto-syncing-a-git-repository/">Auto-syncing a git repository</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/11/reading-in-2019/">Reading in 2019</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/12/building-an-atreus-keyboard/">Building an Atreus keyboard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/23/building-a-onewheel-stand/">Building a Onewheel stand</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/15/switching-my-ergodox-to-qmk-firmware/">Switching my Ergodox to QMK firmware</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Subscribe</h1>
  <p>Looking forward to the next article? 
    Subscribe to the <a href="https://feeds.feedburner.com/JakeMccrarysMusings">RSS</a> feed to receive full articles as they are posted or sign-up for periodic <a target="_blank" href="https://jakemccrary.substack.com/welcome">emails</a> containing links back to this site.
  </p>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <a href="/disclosure-policy">Disclosure Policy</a><br/>
  <a href="//www.iubenda.com/privacy-policy/509351" class="iubenda-nostyle iub-legal-only iubenda-embed" title="Privacy Policy">Privacy Policy</a><br/>
<script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src = "//cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
  Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.
</p>


</footer>
  


</body>
</html>
