<!DOCTYPE html>
<head lang="en">
  <meta charset="utf-8">
  <title>Making code fast: Measure what you intend to measure - Jake McCrary</title>
  <meta name="author" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="stylesheet" href="/style.css"> -->

  <meta itemprop="name" content="Making code fast: Measure what you intend to measure - Jake McCrary" />
  
  <meta itemprop="description" content="When trying to make code faster, make sure sure you are measuring what you think you are measuring." />
  

  <!-- Twitter Card data -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jakemcc" />
  <meta name="twitter:title" content="Making code fast: Measure what you intend to measure - Jake McCrary" />
  
  <meta name="twitter:description" content="When trying to make code faster, make sure sure you are measuring what you think you are measuring." />
  
  <meta name="twitter:creator" content="@jakemcc" />
  <!-- <meta name="twitter:image" content="" /> -->

  <!-- Open Graph data -->
  <meta property="og:site_name" content="Writing by Jake McCrary" />
  <meta property="og:url" content="https://jakemccrary.com//blog/2016/12/31/measure-what-you-intended-to-measure/" />
  <meta property="og:title" content="Making code fast: Measure what you intend to measure - Jake McCrary" />
  
  <meta property="og:description" content="When trying to make code faster, make sure sure you are measuring what you think you are measuring." />
  
  <!-- <meta property="og:image" content="" /> -->
  
  <meta property="og:type" content="article" />
  
  
  <!-- maybe rfc blahblahblah it? -->
  <meta property="article:published_time" content="2016-12-31T23:59:59+00:00" />
  

  <link rel="canonical" href="https://jakemccrary.com//blog/2016/12/31/measure-what-you-intended-to-measure/">

  <style>
   body {
     font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
     max-width: 1200px;
     margin: 0 auto;
     padding: 1rem;
     line-height: 1.5;
   }

   header {
     margin-bottom: 0.5rem;
   }

   header h1 {
     margin: 0;
     font-size: 2.5rem;
   }

   header h1 a {
     color: #333;
     text-decoration: none;
   }

   .main-nav {
     display: flex;
     align-items: center;
     justify-content: space-between;
     padding: 0.5rem 0;
     margin-bottom: 2rem;
   }

   .nav-list {
     display: flex;
     list-style: none;
     margin: 0;
     padding: 0;
     gap: 1.5rem;
   }

   .nav-list a {
     text-decoration: none;
     color: #333;
   }

   .search-form fieldset {
     border: none;
     margin: 0;
     padding: 0;
   }

   .search {
     padding: 0.5rem;
     border: none;
     background: #f5f5f5;
     border-radius: 4px;
   }

   /* Blog post list styling */
   .post-list {
     list-style: none;
     padding: 0;
     margin: 0;
   }

   .post-list li {
     margin-bottom: 1.5rem;
   }

   .post-meta {
     margin-bottom: 0.25rem;
   }

   .post-meta time {
     color: #666;
     margin-right: 0.5rem;
   }

   .post-list h2 {
     display: inline;
     font-size: 1.1rem;
     font-weight: 500;
     margin: 0;
   }

   .post-list h2 a {
     color: #0066cc;
     text-decoration: none;
   }

   .post-list h2 a:hover {
     text-decoration: underline;
   }

   .post-description {
     color: #444;
     margin: 0.25rem 0 0 0;
     line-height: 1.6;
   }

   .right {
     float: right;
   }
   .left {
     float: left;
   }
   .mr1 {
     margin-right: 1em;
   }
   /* Style the footnote references in the text */
   [id^="fnref"] sup {
     font-size: 0.75em;
     line-height: 0;
     position: relative;
     top: -0.5em;
     padding: 0 0.3em;
   }

   [id^="fnref"] a {
     text-decoration: none;
     background-color: #f3f4f6;
     color: #4b5563;
     border-radius: 3px;
     padding: 2px 6px;
     transition: all 0.2s ease;
   }

   [id^="fnref"] a:hover {
     background-color: #e5e7eb;
     color: #1f2937;
   }

   /* Style the footnotes section */
   .footnotes {
     margin-top: 3rem;
     padding-top: 2rem;
     border-top: 2px solid #e5e7eb;
   }

   /* Create custom numbering for footnotes */
   .footnotes li {
     margin-bottom: 1rem;
     color: #4b5563;
   }
   
   /* Style the return links in footnotes */
   .footnotes li a[href^="#fnref"] {
     text-decoration: none;
     color: #6b7280;
     margin-left: 0.5rem;
     font-size: 0.875rem;
     transition: color 0.2s ease;
   }

   .footnotes li a[href^="#fnref"]:hover {
     color: #374151;
   }

   blockquote {
     border-left: 4px solid #d1d5db;
     padding-left: 1em;
     margin-left: 1em;
     color: #4b5563;
     font-style: italic;
     background-color: #f9fafb;
   }

   figure {
     margin: 1rem 0;
     text-align: center;
   }

   figcaption {
     color: #666;
     font-size: 0.9em;
     margin-top: 0.5rem;
     font-style: italic;
   }

   .page-header h1 {
     margin: 0
   }

   .page-header .publication-date {
     color: #666;
     font-size: 0.8em;
     margin: 0;
   }

   body > footer {
     font-size: .8em;
	   color: #888;
     margin-top: 1em;
	   padding-top: 1em;
     padding-bottom: 1em;
   }
   p code, li code {
     display: inline-block;
     white-space: nowrap;
     border: 1px solid #ddd;
     -moz-border-radius: .4em;
     -webkit-border-radius: .4em;
     border-radius: .4em;
     padding: 0 .3em;
     margin: -1px 0;
   }

  </style>
  <link rel="stylesheet" href="/highlight/base16/tomorrow-night.min.css">
</head>
<body>
<header>
    <h1><a href="/">Jake McCrary</a></h1>
  </header>
  <nav role="navigation" class="main-nav">
    <ul role="navigation" class="nav-list">
      <li><a href="/">Articles</a></li>
      <li><a href="/adventures/">Adventures</a></li>
      <li><a href="/about.html">About</a></li>
      <li><a href="/blog/archives/">Archives</a></li>
      <li><a href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      <li><a href="https://jakemccrary.substack.com/welcome" target="_blank" rel="subscribe-email" title="subscribe via email">Newsletter</a></li>
    </ul>
    <form class="search-form" action="https://google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="sitesearch" value="jakemccrary.com">
        <input class="search" type="text" name="q" placeholder="Search">
      </fieldset>
    </form>
  </nav>
  
  <div class="page-header">
    <h1>Making code fast: Measure what you intend to measure</h1>
    
    
    <p class="publication-date">Published on 
      <time datetime="2016-12-31">December 31, 2016</time>
    </p>
    
  </div>
  

  <p>I’ve spent a significant portion of my career figuring out how to make software run faster. It is a problem I enjoy solving. One of the most important steps in an optimization task is to identify what you are trying to optimize and how you will measure it. Answer these questions wrong and you’ll waste your time solving the wrong problem.</p><p>Recently I joined a teammate on a task that involved identifying a bottleneck in a Clojure code base. We knew the code path we needed to optimize and turned to the  <a href='https://github.com/ptaoussanis/tufte'>Tufte</a> library to take timing measurements. This was my first time using Tufte and, with my tiny amount of usage, I like what I see.</p><p>At some point in the process, we had code<a href='#fn-1' id='fnref1'><sup>1</sup></a> that looked similar to the <code>translate</code> function below (lines 20-24).</p><pre><code class="language-clojure">&#40;ns bench.core
  &#40;:require &#91;clojure.string :as string&#93;
            &#91;taoensso.tufte :as tufte&#93;&#41;&#41;

&#40;defn raw-&gt;maps &#91;lines&#93;
  &#40;map &#40;fn &#91;line&#93;
         &#40;zipmap &#91;:a :b :c&#93;
                 &#40;map &#40;fn &#91;s&#93; &#40;Long/parseLong s&#41;&#41;
                      &#40;string/split line #&quot;\|&quot;&#41;&#41;&#41;&#41;
       lines&#41;&#41;

&#40;defn summarize &#91;maps&#93;
  &#40;reduce &#40;fn &#91;r m&#93;
            &#40;-&gt; r
                &#40;update :a &#40;fnil + 0&#41; &#40;:a m&#41;&#41;
                &#40;update :b &#40;fnil + 0&#41; &#40;:b m&#41;&#41;
                &#40;update :c &#40;fnil + 0&#41; &#40;:c m&#41;&#41;&#41;&#41;
          maps&#41;&#41;

&#40;defn translate &#91;lines&#93;
  &#40;tufte/profile {}
                 &#40;let &#91;maps &#40;tufte/p ::raw-&gt;maps &#40;raw-&gt;maps lines&#41;&#41;
                       summary &#40;tufte/p ::summarize &#40;summarize maps&#41;&#41;&#93;
                   summary&#41;&#41;&#41;
</code></pre><p>Here is some Tufte output from running some data through <code>translate</code>.</p><pre><code>                  pId      nCalls       Min        Max       MAD      Mean   Time% Time
:bench.core/summarize           1   346.0ms    346.0ms       0ns   346.0ms     100 346.0ms
:bench.core/raw-&gt;maps           1    2.46µs     2.46µs       0ns    2.46µs       0 2.46µs
           Clock Time                                                          100 346.05ms
       Accounted Time                                                          100 346.0ms
</code></pre><p>Notice anything surprising with the output?<a href='#fn-2' id='fnref2'><sup>2</sup></a></p><p>It surprised me that <code>raw-&gt;maps</code> took such a tiny amount of time compared to the <code>summarize</code> function. Then I realized that we had forgotten about Clojure’s lazy sequences. <code>summarize</code> is taking so much of the time because <code>raw-&gt;maps</code> is just creating a lazy sequence; all the work of realizing that sequence happens in <code>summarize</code>. By wrapping the call to <code>raw-&gt;maps</code> with a <code>doall</code> we were able to get the time measurements we intended.</p><p>This example demonstrates an important lesson. When you are profiling code, make sure you are measuring what you think you are measuring. This can be challenging in languages, such as Clojure, that have a concept of laziness. Reflect on your measurement results and perform a gut check that the results make sense with what you intended to measure. If anything feels off, confirm that you’re measuring what you meant to measure.</p><ol class='footnotes'><li id='fn-1'>Example built using clojure 1.8.0 and tufte 1.1.1. Also, sorry for the terrible names of functions. I was drawing a blank when coming up with this example.<a href='#fnref1'>&#8617;</a></li><li id='fn-2'>Imagine this output having 10 more lines in it. Now imagine it having 20. It starts getting quite a bit more difficult to notice oddities as more and more lines get added to this output. Try not to overwhelm yourself by having too much output.<a href='#fnref2'>&#8617;</a></li></ol>
  <script src="/highlight/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script></script>
  <footer>
    <p xmlns:cc="http://creativecommons.org/ns#" >This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://jakemccrary.com">Jake McCrary</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""></a></p> 
    <a href="/disclosure-policy">Disclosure Policy</a><br/>
  </footer>
</body>
</html>
