<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Restricting access to certain routes - Jake McCrary</title>
  <meta name="author" content="">
  <!-- <link rel="stylesheet" href="/style.css"> -->

  <meta itemprop="name" content="Restricting access to certain routes - Jake McCrary" />
  

  <!-- Twitter Card data -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jakemcc" />
  <meta name="twitter:title" content="Restricting access to certain routes - Jake McCrary" />
  
  <meta name="twitter:creator" content="@jakemcc" />
  <!-- <meta name="twitter:image" content="" /> -->

  <!-- Open Graph data -->
  <meta property="og:site_name" content="Writing by Jake McCrary" />
  <meta property="og:url" content="https://jakemccrary.com//blog/2014/12/21/restricting-access-to-certain-routes/" />
  <meta property="og:title" content="Restricting access to certain routes - Jake McCrary" />
  
  <!-- <meta property="og:image" content="" /> -->
  
  <meta property="og:type" content="article" />
  
  
  <!-- maybe rfc blahblahblah it? -->
  <meta property="article:published_time" content="2014-12-21T23:59:59+00:00" />
  

  <link rel="canonical" href="https://jakemccrary.com//blog/2014/12/21/restricting-access-to-certain-routes/">

  <style>
   body {
     font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
     max-width: 1200px;
     margin: 0 auto;
     padding: 1rem;
     line-height: 1.5;
   }

   header {
     margin-bottom: 0.5rem;
   }

   header h1 {
     margin: 0;
     font-size: 2.5rem;
   }

   header h1 a {
     color: #333;
     text-decoration: none;
   }

   .main-nav {
     display: flex;
     align-items: center;
     justify-content: space-between;
     padding: 0.5rem 0;
     margin-bottom: 2rem;
   }

   .nav-list {
     display: flex;
     list-style: none;
     margin: 0;
     padding: 0;
     gap: 1.5rem;
   }

   .nav-list a {
     text-decoration: none;
     color: #333;
   }

   .search-form fieldset {
     border: none;
     margin: 0;
     padding: 0;
   }

   .search {
     padding: 0.5rem;
     border: none;
     background: #f5f5f5;
     border-radius: 4px;
   }

   /* Blog post list styling */
   .post-list {
     list-style: none;
     padding: 0;
     margin: 0;
   }

   .post-list li {
     margin-bottom: 1.5rem;
   }

   .post-meta {
     margin-bottom: 0.25rem;
   }

   .post-meta time {
     color: #666;
     margin-right: 0.5rem;
   }

   .post-list h2 {
     display: inline;
     font-size: 1.1rem;
     font-weight: 500;
     margin: 0;
   }

   .post-list h2 a {
     color: #0066cc;
     text-decoration: none;
   }

   .post-list h2 a:hover {
     text-decoration: underline;
   }

   .post-description {
     color: #444;
     margin: 0.25rem 0 0 0;
     line-height: 1.6;
   }

   .right {
     float: right;
   }
   .left {
     float: left;
   }
   .mr1 {
     margin-right: 1em;
   }
   /* Style the footnote references in the text */
   [id^="fnref"] sup {
     font-size: 0.75em;
     line-height: 0;
     position: relative;
     top: -0.5em;
     padding: 0 0.3em;
   }

   [id^="fnref"] a {
     text-decoration: none;
     background-color: #f3f4f6;
     color: #4b5563;
     border-radius: 3px;
     padding: 2px 6px;
     transition: all 0.2s ease;
   }

   [id^="fnref"] a:hover {
     background-color: #e5e7eb;
     color: #1f2937;
   }

   /* Style the footnotes section */
   .footnotes {
     margin-top: 3rem;
     padding-top: 2rem;
     border-top: 2px solid #e5e7eb;
   }

   /* Create custom numbering for footnotes */
   .footnotes li {
     margin-bottom: 1rem;
     color: #4b5563;
   }
   
   /* Style the return links in footnotes */
   .footnotes li a[href^="#fnref"] {
     text-decoration: none;
     color: #6b7280;
     margin-left: 0.5rem;
     font-size: 0.875rem;
     transition: color 0.2s ease;
   }

   .footnotes li a[href^="#fnref"]:hover {
     color: #374151;
   }

   blockquote {
     border-left: 4px solid #d1d5db;
     padding-left: 1em;
     margin-left: 1em;
     color: #4b5563;
     font-style: italic;
     background-color: #f9fafb;
   }

   figure {
     margin: 1rem 0;
     text-align: center;
   }

   figcaption {
     color: #666;
     font-size: 0.9em;
     margin-top: 0.5rem;
     font-style: italic;
   }

   .page-header h1 {
     margin: 0
   }

   .page-header .publication-date {
     color: #666;
     font-size: 0.8em;
     margin: 0;
   }

   body > footer {
     font-size: .8em;
	   color: #888;
     margin-top: 1em;
	   padding-top: 1em;
     padding-bottom: 1em;
   }
   p code, li code {
     display: inline-block;
     white-space: nowrap;
     border: 1px solid #ddd;
     -moz-border-radius: .4em;
     -webkit-border-radius: .4em;
     border-radius: .4em;
     padding: 0 .3em;
     margin: -1px 0;
   }

  </style>
  <link rel="stylesheet" href="/highlight/base16/tomorrow-night.min.css">
</head>
<body>
<header>
    <h1><a href="/">Jake McCrary</a></h1>
  </header>
  <nav role="navigation" class="main-nav">
    <ul role="main-navigation" class="nav-list">
      <li><a href="/">Articles</a></li>
      <li><a href="/adventures/">Adventures</a></li>
      <li><a href="/about.html">About</a></li>
      <li><a href="/blog/archives/">Archives</a></li>
      <li><a href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
      <li><a href="https://jakemccrary.substack.com/welcome" target="_blank" rel="subscribe-email" title="subscribe via email">Newsletter</a></li>
    </ul>
    <form class="search-form" action="https://google.com/search" method="get">
      <fieldset role="search">
        <input type="hidden" name="sitesearch" value="jakemccrary.com">
        <input class="search" type="text" name="q" placeholder="Search">
      </fieldset>
    </form>
  </nav>
  
  <div class="page-header">
    <h1>Restricting access to certain routes</h1>
    
    
    <p class="publication-date">Published on 
      <time datetime="2014-12-21">December 21, 2014</time>
    </p>
    
  </div>
  

  <p>Recently I've been working on adding authentication and authorization to a Clojure web service. The project uses <a href='https://github.com/weavejester/compojure'>compojure</a> for routing and <a href='https://github.com/cemerick/friend'>friend</a> for authentication and authorization. My pair and I wanted to restrict access to specific routes while leaving some routes completely public. It took a few tries until we figured out how to do this in a way that made us happy.</p><p>The rest of this post shows the approximate path we took to our current solution. It focuses on using friend to restrict access to specific routes. It does not go into details about adding authentication to your web service.</p><p>Below is an example of the routes before adding authorization checks.</p><pre><code class="language-clojure">&#40;ns example.server
  &#40;:require &#91;compojure.core :refer &#91;GET defroutes&#93; :as compojure&#93;
            &#91;compojure.route :as route&#93;&#41;&#41;

&#40;defroutes app
  &#40;GET &quot;/status&quot; &#95; &#40;status&#41;&#41;
  &#40;GET &quot;/cars&quot; &#95; &#40;fetch-cars&#41;&#41;
  &#40;GET &quot;/attributes&quot; &#95; &#40;fetch-attributes&#41;&#41;
  &#40;GET &quot;/drivers&quot; &#95; &#40;fetch-drivers&#41;&#41;
  &#40;route/not-found &quot;NOT FOUND&quot;&#41;&#41;
</code></pre><p>We wanted to make <code>/cars</code>, <code>/attributes</code>, and <code>/drivers</code> require that the request satisfies the <code>:example.server/user</code> role. Requesting <code>/status</code> should not require authorization. The first attempt left us with the following code.</p><pre><code class="language-clojure">&#40;ns example.server
  &#40;:require &#91;compojure.core :refer &#91;GET defroutes&#93; :as compojure&#93;
            &#91;compojure.route :as route&#93;
            &#91;cemerick.friend :as friend&#93;&#41;&#41;

&#40;defroutes app
  &#40;GET &quot;/status&quot; &#95; &#40;status&#41;&#41;
  &#40;GET &quot;/cars&quot; &#95;
       &#40;friend/authorize #{::user}
                         &#40;fetch-cars&#41;&#41;&#41;
  &#40;GET &quot;/attributes&quot; &#95;
       &#40;friend/authorize #{::user}
                         &#40;fetch-attributes&#41;&#41;&#41;
  &#40;GET &quot;/drivers&quot; &#95;
       &#40;friend/authorize #{::user}
                         &#40;fetch-drivers&#41;&#41;&#41;
  &#40;route/not-found &quot;NOT FOUND&quot;&#41;&#41;
</code></pre><p>The above works but it suffers from repetition. You could write a macro to minimize the repetition but we thought there must be a better way.</p><p>After reading more of <a href='https://github.com/cemerick/friend'>friend</a>'s documentation we discovered <code>friend/wrap-authorize</code>. This is middleware that only allows requests through if the request satisfies the required roles. Our first pass at using <code>friend/wrap-authorize</code> looked like the following example.</p><pre><code class="language-clojure">&#40;ns example.server
  &#40;:require &#91;compojure.core :refer &#91;GET defroutes&#93; :as compojure&#93;
            &#91;compojure.route :as route&#93;
            &#91;cemerick.friend :as friend&#93;&#41;&#41;

&#40;defroutes protected-routes
  &#40;GET &quot;/cars&quot; &#95; &#40;fetch-cars&#41;&#41;
  &#40;GET &quot;/attributes&quot; &#95; &#40;fetch-attributes&#41;&#41;
  &#40;GET &quot;/drivers&quot; &#95; &#40;fetch-drivers&#41;&#41;&#41;

&#40;defroutes app
  &#40;GET &quot;/status&quot; &#95; &#40;status&#41;&#41;
  &#40;friend/wrap-authorize protected-routes #{::user}&#41;
  &#40;route/not-found &quot;NOT FOUND&quot;&#41;&#41;
</code></pre><p>This is much nicer. The repetition is removed by extracting routes that require authorization into a separate <code>defroutes</code> and wrapping it with <code>friend/wrap-authorize</code>.</p><p>This introduces a subtle bug. A response with status code 404 is no longer returned if a non-existent resource is requested and the request is unauthorized. This is because the authorization check happens <i>before</i> matching a route. friend's documentation warns against this and suggests using <code>compojure/context</code> to scope usage of <code>friend/wrap-authorize</code>. This doesn't solve the problem but it at least narrows its scope. We can do better.</p><p>Compojure <a href='https://github.com/weavejester/compojure/blob/master/HISTORY.md'>1.2.0</a> introduced the function <code>wrap-routes</code>. <code>wrap-routes</code> applies middleware <i>after</i> a route is matched. By using this we can have all of the benefits of using <code>friend/wrap-authorize</code> without breaking returning 404 responses.</p><pre><code class="language-clojure">&#40;ns example.server
  &#40;:require &#91;compojure.core :refer &#91;GET defroutes&#93; :as compojure&#93;
            &#91;compojure.route :as route&#93;
            &#91;cemerick.friend :as friend&#93;&#41;&#41;

&#40;defroutes protected-routes
  &#40;GET &quot;/cars&quot; &#95; &#40;fetch-cars&#41;&#41;
  &#40;GET &quot;/attributes&quot; &#95; &#40;fetch-attributes&#41;&#41;
  &#40;GET &quot;/drivers&quot; &#95; &#40;fetch-drivers&#41;&#41;&#41;

&#40;defroutes app
  &#40;GET &quot;/status&quot; &#95; &#40;status&#41;&#41;
  &#40;compojure/wrap-routes protected-routes
                         friend/wrap-authorize
                         #{::user}&#41;
  &#40;route/not-found &quot;NOT FOUND&quot;&#41;&#41;
</code></pre><p>There we have it. A solution without duplication that still responds properly to requests for non-existent resources. <code>compojure/wrap-routes</code> is a useful function to know about.   </p>
  <script src="/highlight/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script></script>
  <footer>
    <p xmlns:cc="http://creativecommons.org/ns#" >This work by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="https://jakemccrary.com">Jake McCrary</a> is licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""></a></p> 
    <a href="/disclosure-policy">Disclosure Policy</a><br/>
  </footer>
</body>
</html>
