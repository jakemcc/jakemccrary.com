
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="iem7"><![endif]-->
<!--[if lt IE 9]><html class="lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html lang="en"><!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <title>Jake McCrary</title>
    <meta name="author" content="Jake McCrary">

    
    
    
    

    <meta itemprop="name" content="Jake McCrary" />
    <meta itemprop="description" content=" I was interacting with a SQL database using Clojure and needed to create a table so I turned to create-table from clojure.contrib.sql. Looking at the &hellip;" />

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@jakemcc" />
    <meta name="twitter:title" content="Jake McCrary" />
    <meta name="twitter:description" content=" I was interacting with a SQL database using Clojure and needed to create a table so I turned to create-table from clojure.contrib.sql. Looking at the &hellip;" />
    <meta name="twitter:creator" content="@jakemcc" />
    <meta name="twitter:image" content="https://jakemccrary.com/images/jake-surprised-eyes-brighter.jpg" />

    <!-- Open Graph data -->
    <meta property="og:site_name" content="The Blog of Jake McCrary" />
    <meta property="og:url" content="https://jakemccrary.com/blog/10/" />
    <meta property="og:title" content="Jake McCrary" />
    <meta property="og:description" content=" I was interacting with a SQL database using Clojure and needed to create a table so I turned to create-table from clojure.contrib.sql. Looking at the &hellip;" />
    <meta property="og:image" content="https://jakemccrary.com/images/jake-surprised-eyes-brighter.jpg" />
    
    

    <meta name="description" content=" I was interacting with a SQL database using Clojure and needed to create a table so I turned to create-table from clojure.contrib.sql. Looking at the &hellip;">

    

    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://jakemccrary.com/blog/10/">
    <link href="/favicon.png" rel="icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="alternate" title="Jake McCrary" type="application/atom+xml">
    <link href="https://jakemccrary.com/feed.json" rel="alternate" title="Jake McCrary" type="application/json">

    <!-- iOS scaling bug fix Rewritten version By @mathias, @cheeaun and @jdalton Source url: https://gist.github.com/901295 -->
    <script type="text/javascript">
     (function(doc) {
       var addEvent = 'addEventListener',
           type = 'gesturestart',
           qsa = 'querySelectorAll',
           scales = [1, 1],
           meta = qsa in doc ? doc[qsa]('meta[name=viewport]') : [];
       function fix() {
         meta.content = 'width=device-width,minimum-scale=' + scales[0] + ',maximum-scale=' + scales[1];
         doc.removeEventListener(type, fix, true);
       }
       if ((meta = meta[meta.length - 1]) && addEvent in doc) {
         fix();
         scales = [0.25, 1.6];
         doc[addEvent](type, fix, true);
       }
     }(document));
    </script>
    
<script>
 var origin = window.location.origin;
 if (!origin) {
   origin = window.location.protocol + '//' + window.location.hostname + (window.location.port ? (':' + window.location.port) : '');
 }
 if (origin.indexOf('localhost') === -1) {
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

   ga('create', 'UA-19834208-2', 'auto');
   ga('send', 'pageview');
 }
</script>


  </head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jake McCrary</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul role=main-navigation>
  <li><a href="/">Articles</a></li>
  <li><a href="/adventures/">Adventures</a></li>
  <li><a href="/about.html">About</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
</ul>

  <form action="https://google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="sitesearch" value="jakemccrary.com">
      <input class="search" type="text" name="q" placeholder="Search"/>
    </fieldset>
  </form>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/19/creating-sql-table-with-composite-key-in-clojure/">Creating a SQL table with a composite primary key in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-01-19T00:00:00-06:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I was interacting with a SQL database using Clojure and needed to create a table so I turned to <code>create-table</code> from <a href="http://clojure.github.com/clojure-contrib/sql-api.html">clojure.contrib.sql</a>. Looking at the <a href="http://clojure.github.com/clojure-contrib/sql-api.html#clojure.contrib.sql/create-table">docs</a> for <code>create-table</code> it seemed pretty straight forward. To create a table with columns <em>date</em>, <em>id</em>, <em>symbol</em>, <em>price</em>, and <em>quantity</em> you would write the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">create-table</span> <span class="s">&quot;orders&quot;</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:date</span>     <span class="s">&quot;date&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:id</span>       <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:symbol</span>   <span class="s">&quot;char(10)&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:price</span>    <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:quantity</span> <span class="s">&quot;integer&quot;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above works. I also wanted to specify that columns <em>date</em> and <em>id</em> to form a composite primary key. I wasn&rsquo;t sure how to specify a composite primary key with <code>create-table</code> and ended up diving into its <a href="https://github.com/clojure/clojure-contrib/blob/b8d2743d3a89e13fc9deb2844ca2167b34aaa9b6/src/main/clojure/clojure/contrib/sql.clj#L103">code</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-table</span>
</span><span class='line'>  <span class="s">&quot;Creates a table on the open database connection given a table name and</span>
</span><span class='line'><span class="s">  specs. Each spec is either a column spec: a vector containing a column</span>
</span><span class='line'><span class="s">  name and optionally a type and other constraints, or a table-level</span>
</span><span class='line'><span class="s">  constraint: a vector containing words that express the constraint. All</span>
</span><span class='line'><span class="s">  words used to describe the table may be supplied as strings or keywords.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="o">&amp;</span> <span class="nv">specs</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-commands</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;CREATE TABLE %s (%s)&quot;</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">as-str</span> <span class="nv">name</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">apply str </span>
</span><span class='line'>             <span class="p">(</span><span class="nb">map </span><span class="nv">as-str</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">apply concat </span>
</span><span class='line'>               <span class="p">(</span><span class="nf">interpose</span> <span class="p">[</span><span class="s">&quot;, &quot;</span><span class="p">]</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">interpose</span> <span class="s">&quot; &quot;</span><span class="p">)</span> <span class="nv">specs</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at <code>create-table</code> we can see it creates a SQL statement which is then executed by <code>do-commands</code>. In order to have a composite key we need <code>do-commands</code> to execute a SQL statement that looks similar to below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">track</span><span class="p">(</span>
</span><span class='line'>  <span class="nb">date</span> <span class="nb">date</span><span class="p">,</span>
</span><span class='line'>  <span class="n">id</span> <span class="nb">integer</span><span class="p">,</span>
</span><span class='line'>  <span class="n">symbol</span> <span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
</span><span class='line'>  <span class="n">price</span> <span class="nb">integer</span><span class="p">,</span>
</span><span class='line'>  <span class="n">quantity</span> <span class="nb">integer</span><span class="p">,</span>
</span><span class='line'>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s break down <code>create-table</code> to figure out what we need to pass it to make <code>do-commands</code> run the above statement. The code for <code>create-table</code> is repeated below with comments pointing out what step lines up the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">create-table</span>
</span><span class='line'>  <span class="p">[</span><span class="nb">name </span><span class="o">&amp;</span> <span class="nv">specs</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-commands</span>                                              <span class="c1">; step 7</span>
</span><span class='line'>   <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;CREATE TABLE %s (%s)&quot;</span>                           <span class="c1">; step 6</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">as-str</span> <span class="nv">name</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">apply str </span>                                      <span class="c1">; step 5</span>
</span><span class='line'>             <span class="p">(</span><span class="nb">map </span><span class="nv">as-str</span>                                    <span class="c1">; step 4</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">apply concat </span>                                <span class="c1">; step 3</span>
</span><span class='line'>               <span class="p">(</span><span class="nf">interpose</span> <span class="p">[</span><span class="s">&quot;, &quot;</span><span class="p">]</span>                            <span class="c1">; step 2</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">partial </span><span class="nv">interpose</span> <span class="s">&quot; &quot;</span><span class="p">)</span> <span class="nv">specs</span><span class="p">))))))))</span>  <span class="c1">; step 1</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>First <code>create-table</code> takes the sequences in <code>specs</code> and puts a space between each element in each sequence.</li>
<li>The result of step 1 then has a vector containing a comma and a space interposed between each element of it.</li>
<li><code>concat</code> combined with <code>apply</code> is used to combine each element of the result of step 2 into a single sequence.</li>
<li><code>as-str</code> (from <a href="http://clojure.github.com/clojure-contrib/string-api.html#clojure.contrib.string/as-str">c.c.string</a>) is mapped over the result of step 3 to make sure every element is a string.</li>
<li><code>str</code> is used to make one string out of the sequence of strings from step 4.</li>
<li><code>format</code> is used to substitute in <code>name</code> and the result of step 5 to create the SQL statement.</li>
<li><code>do-commands</code> executes the statement created in step 6.</li>
</ol>


<p>Knowing how <code>create-table</code> works now allows us to specify the arguments that will create the orders table with the composite primary key of <em>date</em> and <em>id</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">create-table</span> <span class="s">&quot;orders&quot;</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:date</span>     <span class="s">&quot;date&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:id</span>       <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:symbol</span>   <span class="s">&quot;char(10)&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:price</span>    <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="ss">:quantity</span> <span class="s">&quot;integer&quot;</span><span class="p">]</span>
</span><span class='line'>              <span class="p">[</span><span class="s">&quot;PRIMARY KEY&quot;</span> <span class="s">&quot;(date, id)&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/01/18/generating-test-cases-in-clojure/">Generating test cases in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2011-01-18T00:00:00-06:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2011</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I was writing some data mining Clojure code which needed to parse a log file and do some transforms of the data. Some of the transforms were dependent on data found across multiple lines. There was no ordering or proximity guarantees to these lines.</p>

<p>This required the code to handle a variety of situations. After writing a couple simple tests and getting those passing I wanted to more extensively test my solution. I was lazy though and did not want to hand code all of the potential orderings.  Enter <code>permutations</code>.</p>

<p><code>permutations</code> is a function out of <a href="http://clojure.github.com/clojure-contrib/combinatorics-api.html">clojure.contrib.combinatorics</a>. As the name suggests, you give it a collection and it returns a lazy sequence containing all the different permutations of the elements in that collection. An example is below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">user&gt;</span><span class="p">(</span><span class="kd">ns </span><span class="nv">generate</span><span class="p">)</span>
</span><span class='line'><span class="nv">generate&gt;</span><span class="p">(</span><span class="nf">use</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.contrib.combinatorics</span> <span class="ss">:only</span> <span class="p">[</span><span class="nv">permutations</span><span class="p">]])</span>
</span><span class='line'><span class="nv">nil</span>
</span><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">permutations</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span> <span class="ss">:c</span><span class="p">])</span>
</span><span class='line'><span class="p">((</span><span class="ss">:a</span> <span class="ss">:b</span> <span class="ss">:c</span><span class="p">)</span> <span class="p">(</span><span class="ss">:a</span> <span class="ss">:c</span> <span class="ss">:b</span><span class="p">)</span> <span class="p">(</span><span class="ss">:b</span> <span class="ss">:a</span> <span class="ss">:c</span><span class="p">)</span> <span class="p">(</span><span class="ss">:b</span> <span class="ss">:c</span> <span class="ss">:a</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c</span> <span class="ss">:a</span> <span class="ss">:b</span><span class="p">)</span> <span class="p">(</span><span class="ss">:c</span> <span class="ss">:b</span> <span class="ss">:a</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can already see where this is going. I was able to use <code>permutations</code> to generate all the potential different orderings of the input. This saved me the trouble of having to do that by hand.</p>

<p>One difficulty of generating test inputs pragmatically is telling what sort of inputs caused it to fail. To get around this I used the rarely used (at least in code I&rsquo;m working on) second argument of <a href="http://clojure.github.com/clojure/clojure.test-api.html#clojure.test/is">clojure.test&rsquo;s</a> <code>is</code>. This second argument is a message that prints on a failure.</p>

<p>Below is a contrived example of using <code>permutations</code> to test an obviously wrong <code>silly-add</code> function. <code>silly-add</code> is defined below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="kd">defn </span><span class="nv">silly-add</span>
</span><span class='line'>              <span class="p">[</span><span class="nv">x</span> <span class="o">&amp;</span> <span class="nv">xs</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">x</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">(</span><span class="nb">apply + </span><span class="mi">40</span> <span class="nv">xs</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">(</span><span class="nb">apply + </span><span class="nv">x</span> <span class="nv">xs</span><span class="p">)))</span>
</span><span class='line'><span class="o">#</span><span class="ss">&#39;generate/silly-add</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is a test that uses <code>permutations</code> to exercise <code>silly-add</code> with all the potential orderings three input numbers. Note that it takes advantage of the second argument to <code>is</code>. Without this we would not know what input caused the failure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;clojure.test</span><span class="p">)</span>
</span><span class='line'><span class="nv">nil</span>
</span><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">deftest</span> <span class="nv">generate-some-tests</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">input</span> <span class="p">(</span><span class="nf">permutations</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">9</span><span class="p">])]</span>
</span><span class='line'>                   <span class="p">(</span><span class="nf">is</span> <span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">silly-add</span> <span class="nv">input</span><span class="p">))</span>
</span><span class='line'>                       <span class="p">(</span><span class="nb">str </span><span class="s">&quot;Failed on input: &quot;</span> <span class="p">(</span><span class="nb">seq </span><span class="nv">input</span><span class="p">)))))</span>
</span><span class='line'><span class="o">#</span><span class="ss">&#39;generate/generate-some-tests</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the test we see that there is clearly an error.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">generate&gt;</span> <span class="p">(</span><span class="nf">run-tests</span><span class="p">)</span>
</span><span class='line'><span class="nv">Testing</span> <span class="nv">generate</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FAIL</span> <span class="nv">in</span> <span class="p">(</span><span class="nf">generate-some-tests</span><span class="p">)</span> <span class="p">(</span><span class="nf">NO_SOURCE_FILE</span><span class="ss">:1</span><span class="p">)</span>
</span><span class='line'><span class="nv">Failed</span> <span class="nv">on</span> <span class="nv">input</span><span class="err">:</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">9</span><span class="p">)</span>
</span><span class='line'><span class="nv">expected</span><span class="err">:</span> <span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">silly-add</span> <span class="nv">input</span><span class="p">))</span>
</span><span class='line'>  <span class="nv">actual</span><span class="err">:</span> <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="mi">50</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FAIL</span> <span class="nv">in</span> <span class="p">(</span><span class="nf">generate-some-tests</span><span class="p">)</span> <span class="p">(</span><span class="nf">NO_SOURCE_FILE</span><span class="ss">:1</span><span class="p">)</span>
</span><span class='line'><span class="nv">Failed</span> <span class="nv">on</span> <span class="nv">input</span><span class="err">:</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">9</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">expected</span><span class="err">:</span> <span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">silly-add</span> <span class="nv">input</span><span class="p">))</span>
</span><span class='line'>  <span class="nv">actual</span><span class="err">:</span> <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">10</span> <span class="mi">50</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>permutations</code> saved me a bit of time and let me test some situations that I otherwise would not have tested. This actually exposed a subtle bug in my code. Hopefully it can do the same for you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/07/quickily-starting-a-powerful-clojure-repl/">Quickly starting a powerful Clojure REPL</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-12-07T00:00:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I often find myself browsing the Internet and then suddenly I want to have a Clojure REPL at my fingertips. As I&rsquo;ve become better with emacs and <a href="http://www.emacswiki.org/ParEdit">paredit</a> I&rsquo;ve become dependent on the powerful editing this combo affords. The rest of this post details how I changed my five step process into a two step process. It does not explain basic emacs/slime setup but rather explains how I cut a few steps out of a suboptimal workflow for getting a powerful Clojure REPL up and running in emacs.</p>

<p>My previous workflow was the following:</p>

<ol>
<li>Open a terminal</li>
<li>Change to the root of Clojure project where I use <a href="https://github.com/technomancy/leiningen">Leiningen</a> and have swank-clojure as a dependency.</li>
<li>Run the command <code>lein swank</code></li>
<li>Start emacs</li>
<li>Run <code>M-x slime-connect</code></li>
</ol>


<p>This five step process was terrible. From me seeing something interesting to try to having a REPL open took too much time.</p>

<p>Today I changed my process so it on takes two steps. They are:</p>

<ol>
<li>Start emacs</li>
<li>Run <code>M-x clojure-swank</code></li>
</ol>


<p>This is a much better. I&rsquo;ll admit had a lot of room for improvement so it wasn&rsquo;t too hard to make it better. Below are the steps I took to cut three steps.</p>

<p>First, using Leiningen 1.4.0, I ran <code>lein install swank-clojure 1.3.0-SNAPSHOT</code>. This installed a script called swank-clojure into $HOME/.lein/bin. When run, this script starts a swank server waiting for connections on port 4005.</p>

<p>Next I wrote a function in <a href="http://en.wikipedia.org/wiki/Emacs_Lisp">elisp</a> that gives emacs the ability to call the newly installed swank-clojure script, wait for the swank server to start, and then connect to it. This function, <code>clojure-swank</code>, can be seen below. It creates a buffer named <code>*clojure-swank*</code>, runs the newly installed script, and captures the output in the freshly created buffer. When the &ldquo;Connection opened&rdquo; line appears <code>slime-connect</code> is called, connecting emacs to the freshly started swank server. After this we are at the REPL with all the advantages that emacs and paredit give us.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='cl'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">clojure-swank</span> <span class="p">()</span>
</span><span class='line'>  <span class="s">&quot;Launch swank-clojure from users homedir/.lein/bin&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">buffer</span> <span class="p">(</span><span class="nv">get-buffer-create</span> <span class="s">&quot;*clojure-swank*&quot;</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">display-buffer</span> <span class="p">(</span><span class="nv">buffer-or-name</span> <span class="k">&amp;optional</span> <span class="nv">not-this-window</span> <span class="nv">frame</span><span class="p">)</span> <span class="no">nil</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">bury-buffer</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">shell-command</span> <span class="s">&quot;~/.lein/bin/swank-clojure &amp;&quot;</span> <span class="nv">buffer</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">set-process-filter</span> <span class="p">(</span><span class="nv">get-buffer-process</span> <span class="nv">buffer</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">process</span> <span class="nv">output</span><span class="p">)</span>
</span><span class='line'>                           <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;*clojure-swank*&quot;</span> <span class="p">(</span><span class="nv">insert</span> <span class="nv">output</span><span class="p">))</span>
</span><span class='line'>                           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">string-match</span> <span class="s">&quot;Connection opened on local port +\\([0-9]+\\)&quot;</span> <span class="nv">output</span><span class="p">)</span>
</span><span class='line'>                             <span class="p">(</span><span class="nv">slime-connect</span> <span class="s">&quot;localhost&quot;</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span> <span class="nv">output</span><span class="p">))</span>
</span><span class='line'>                             <span class="p">(</span><span class="nv">set-process-filter</span> <span class="nv">process</span> <span class="no">nil</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">message</span> <span class="s">&quot;Starting swank.. &quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve also written a <code>clojure-kill-swank</code> function for stopping the swank server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cl'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">clojure-kill-swank</span> <span class="p">()</span>
</span><span class='line'>  <span class="s">&quot;Kill swank process started by lein swank.&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nv">get-buffer-process</span> <span class="s">&quot;*clojure-swank*&quot;</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when</span> <span class="nv">process</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nv">slime-quit-lisp</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">timeout</span> <span class="mi">10</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">timeout</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">eql</span> <span class="ss">&#39;run</span> <span class="p">(</span><span class="nv">process-status</span> <span class="nv">process</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">sit-for</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">decf</span> <span class="nv">timeout</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nv">kill-buffer</span> <span class="s">&quot;*clojure-swank*&quot;</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both of those functions need to be added to a location where they will get defined on emacs start-up. Once this is done the powerful REPL you are used to emacs providing can be at your finger tips in practically no time at all.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/06/trampolining-through-mutual-recursion/">Trampolining through mutual recursion with Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-12-06T00:00:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>The other day I stumbled across some <a href="http://clojure.org">Clojure</a> code that used <a href="http://en.wikipedia.org/wiki/Mutual_recursion">mutual recursion</a>. Mutual recursion can be a valuable tool when solving a problem. Unfortunately because of the lack of <a href="http://en.wikipedia.org/wiki/Tail_call">tail call optimization</a> on the JVM this can be a dangerous technique when writing Clojure code. It can be easy to forget about this limitation and end up writing code that blows the stack.</p>

<p>Take the classic even/odd checking code from the <a href="http://en.wikipedia.org/wiki/Mutual_recursion">Wikipedia</a> page. If we just translate it to Clojure it will cause a <a href="http://en.wikipedia.org/wiki/Stack_overflow">stack overflow</a> error when we pass in a large number. The massive number of function calls require before returning causes too much memory to be consumed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">declare </span><span class="nv">my-odd?</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-even?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">true</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">my-odd?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-odd?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">false</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">my-even?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">my-even?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="c1">; Evaluation aborted. &lt;- this is a result of java.util.StackOverflowError</span>
</span></code></pre></td></tr></table></div></figure>


<p>Luckily since Clojure 1.0 there has been a useful function for dealing with this. <code>trampoline</code>, with minor modifications to your code, can be used to get around the lack of tail call optimizations (<a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/trampoline">docs here</a>).</p>

<p><code>trampoline</code> takes a function (and, if needed, arguments to pass into the function) and calls it. If the function returns a function then <code>trampoline</code> calls that. As long as functions are returned <code>trampoline</code> will continue calling them. When a non-function value is returned <code>trampoline</code> returns, passing through the value.</p>

<p>To make our sample code work with <code>trampoline</code> we simply change our functions to return a closure which wraps the call that was previously being executed. This just entails putting a <code>#</code> before the final s-exp. This takes advantage of Clojure&rsquo;s anonymous function syntax to change the function call into a closure which is returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-even?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">true</span>
</span><span class='line'>    <span class="o">#</span><span class="p">(</span><span class="nf">my-odd?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-odd?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">false</span>
</span><span class='line'>    <span class="o">#</span><span class="p">(</span><span class="nf">my-even?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>By doing this we&rsquo;ve changed how the caller interacts with <code>my-even?</code> and <code>my-odd?</code>. It now needs to be called by <code>trampoline</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">trampoline</span> <span class="nv">my-even?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="nv">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we no longer suffer from the stack overflow error.</p>

<p>I think we can still do better though, because now the caller of <code>my-even?</code> and <code>my-odd?</code> suffers since they are forced to remember to use <code>trampoline</code>. By forcing this on the caller, we&rsquo;ve pushed what should be hidden implementations details into the callers code. We can fix this by pushing the use of <code>trampoline</code> into our functions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-even?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">letfn</span> <span class="p">[(</span><span class="nf">e?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">true</span>
</span><span class='line'>                <span class="o">#</span><span class="p">(</span><span class="nf">o?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">o?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">zero? </span><span class="nv">n</span><span class="p">)</span>
</span><span class='line'>                <span class="nv">false</span>
</span><span class='line'>                <span class="o">#</span><span class="p">(</span><span class="nf">e?</span> <span class="p">(</span><span class="nb">dec </span><span class="p">(</span><span class="nf">Math/abs</span> <span class="nv">n</span><span class="p">)))))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">trampoline</span> <span class="nv">e?</span> <span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">my-odd?</span> <span class="p">[</span><span class="nv">n</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">my-even?</span> <span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">my-even?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="nv">true</span>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">my-odd?</span> <span class="mi">1000000</span><span class="p">)</span>
</span><span class='line'><span class="nv">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have the best of both worlds. Mutual recursion without the worry of a stack overflow and functions that don&rsquo;t force the caller to be aware of the implementation details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/06/06/inserting-values-into-a-nested-map-in-clojure/">Inserting values into a nested map in Clojure</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-06-06'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I was writing some Clojure with a coworker and we needed to insert values into a nested map structure. Our first solution (and example of using it at the repl) looked something like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add-to-cache</span> <span class="p">[</span><span class="nv">cache</span> <span class="nv">key1</span> <span class="nv">key2</span> <span class="nv">data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">entry</span> <span class="p">(</span><span class="nb">get </span><span class="nv">cache</span> <span class="nv">key1</span> <span class="p">{})</span>
</span><span class='line'>        <span class="nv">new-entry</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">entry</span> <span class="nv">key2</span> <span class="nv">data</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">assoc </span><span class="nv">cache</span> <span class="nv">key1</span> <span class="nv">new-entry</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">add-to-cache</span> <span class="p">{}</span> <span class="ss">:chicago</span> <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:sf</span> <span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:chicago</span> <span class="ss">:wickerpark</span> <span class="ss">:alex</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span><span class="ss">:sf</span> <span class="p">{</span><span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">}</span>, <span class="ss">:chicago</span> <span class="p">{</span><span class="ss">:wickerpark</span> <span class="ss">:alex</span>, <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This worked but seemed overly verbose for doing what (in our minds) should have been a simple operation. After some digging around in the docs we found the function <code>assoc-in</code>. This useful function allowed us to greatly simplify the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">add-to-cache</span> <span class="p">[</span><span class="nv">cache</span> <span class="nv">key1</span> <span class="nv">key2</span> <span class="nv">data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">assoc-in</span> <span class="nv">cache</span> <span class="p">[</span><span class="nv">key1</span> <span class="nv">key2</span><span class="p">]</span> <span class="nv">data</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">add-to-cache</span> <span class="p">{}</span> <span class="ss">:chicago</span> <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:sf</span> <span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">add-to-cache</span> <span class="ss">:chicago</span> <span class="ss">:wickerpark</span> <span class="ss">:alex</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span><span class="ss">:sf</span> <span class="p">{</span><span class="ss">:mission</span> <span class="ss">:dan</span><span class="p">}</span>, <span class="ss">:chicago</span> <span class="p">{</span><span class="ss">:wickerpark</span> <span class="ss">:alex</span>, <span class="ss">:lakeview</span> <span class="ss">:jake</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much simpler and easier to read. The next person to look at the code will be able to quickly skim and tell what the code is doing.</p>

<p><code>assoc-in</code> can also be used with nested associative structures like vectors.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">assoc-in</span> <span class="p">[[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span><span class="p">]]</span> <span class="p">[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="ss">:z</span><span class="p">)</span>
</span><span class='line'><span class="p">[[</span><span class="mi">0</span> <span class="ss">:z</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span><span class="p">]]</span>
</span><span class='line'><span class="nv">user&gt;</span> <span class="p">(</span><span class="nf">assoc-in</span> <span class="p">[[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:b</span><span class="p">]]</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">1</span><span class="p">]</span> <span class="ss">:z</span><span class="p">)</span>
</span><span class='line'><span class="p">[[</span><span class="mi">0</span> <span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="ss">:a</span> <span class="ss">:z</span><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully this post makes searching for how to insert into nested maps slighly easier for the next person who thinks there must be a better way for doing this.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/21/plotting-time-series-data-with-incanter/">Plotting time series data with Incanter</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2010-02-21'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2010</span></span> <span class='time'>12:00 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I found myself wanting to plot some time series data and wanted to do this in Clojure. Unfortunately Incanter, a good statistical and graphics library for Clojure, did not provide a way to plot data where the x-axis is a time value. A quick fork on github and a pull request later and now Incanter does. Since I added this functionality I thought I would write up a short example of using it.</p>

<p>The example time series data Im using I took from Yahoos <a href="http://finance.yahoo.com/">finance section</a>. <a href="http://ichart.finance.yahoo.com/table.csv?s=YHOO&amp;a=03&amp;b=12&amp;c=1996&amp;d=01&amp;e=21&amp;f=2010&amp;g=d&amp;ignore=.csv">Here</a> is a link to the csv file I used.</p>

<p>Im using the <code>read-dataset</code> function provided by Incanter. This procedure reads a delimited file (or URL) and returns an Incanter dataset.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">yhoo</span> <span class="p">(</span><span class="nf">read-dataset</span> <span class="s">&quot;table.csv&quot;</span> <span class="ss">:header</span> <span class="nv">true</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yahoo stores the date in a yyyy-mm-dd format. I need to convert that to milliseconds from the epoch so it can be used in time-series-plot as the x-axis data. To do this I wrote a function which takes the string representation of the date, splits in on -, then use the <code>joda-date</code> and <code>to-ms</code> functions from incanter.chrono to get the number of milliseconds from the epoch.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">to-milliseconds-from-epoch</span> <span class="p">[</span><span class="nv">x</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">to-ms</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">apply </span><span class="nv">joda-date</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">Integer/parseInt</span> <span class="nv">%</span><span class="p">)</span>
</span><span class='line'>                           <span class="p">(</span><span class="nf">.split</span> <span class="nv">x</span> <span class="s">&quot;-&quot;</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have a function which takes the string representation and get the milliseconds it is time to get the data I want from the dataset. The below code selects the <code>:Close</code> and <code>:Date</code> column while mapping the <code>:Date</code> column to a millisecond from epoch representation of date.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">mod-data</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">col-names</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">conj-cols</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">$</span> <span class="ss">:Close</span> <span class="nv">yhoo</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">$map</span> <span class="nv">to-milliseconds-from-epoch</span> <span class="ss">:Date</span> <span class="nv">yhoo</span><span class="p">))</span>
</span><span class='line'>     <span class="p">[</span><span class="ss">:Close</span> <span class="ss">:Date</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next step is to use the <code>time-series-plot</code> function to actually create the plot. Because the data we have is in a dataset, we can pass in the column names as the x and y parameters and provide the data set as the value to the <code>:data</code> key in the optional parameters.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">chart</span> <span class="p">(</span><span class="nf">time-series-plot</span> <span class="ss">:Date</span> <span class="ss">:Close</span>
</span><span class='line'>                             <span class="ss">:x-label</span> <span class="s">&quot;Date&quot;</span>
</span><span class='line'>                             <span class="ss">:y-label</span> <span class="s">&quot;Closing Price&quot;</span>
</span><span class='line'>                             <span class="ss">:title</span> <span class="s">&quot;Closing price over time for Yahoo&quot;</span>
</span><span class='line'>                             <span class="ss">:data</span> <span class="nv">mod-data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we use the Incanter function <code>view</code> to actually see the chart.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">view</span> <span class="nv">chart</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="/images/yhoo.png" title="Chart of historical YHOO closing prices" alt="Chart of historical YHOO closing prices" /></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog//9">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/02/25/auto-syncing-a-git-repository/">Auto-syncing a git repository</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/11/reading-in-2019/">Reading in 2019</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/12/building-an-atreus-keyboard/">Building an Atreus keyboard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/23/building-a-onewheel-stand/">Building a Onewheel stand</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/15/switching-my-ergodox-to-qmk-firmware/">Switching my Ergodox to QMK firmware</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/04/30/how-i-use-social-media/">How I use social media</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/03/20/breaking-change-and-more-in-lein-test-refresh-0-dot-24-dot-0/">Breaking change and more in lein-test-refresh 0.24.1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/02/13/testing-asynchronous-javascript-with-jasmine/">Testing asynchronous JavaScript with Jasmine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/01/28/how-to-use-leiningen-test-selectors-to-filter-by-test-name/">How to use Leiningen test selectors to filter by test name</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/01/27/how-to-display-a-message-to-all-tmux-clients/">How to display a message to all tmux clients</a>
      </li>
    
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <a href="/disclosure-policy">Disclosure Policy</a><br/>
  <a href="//www.iubenda.com/privacy-policy/509351" class="iubenda-nostyle iub-legal-only iubenda-embed" title="Privacy Policy">Privacy Policy</a><br/>
<script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src = "//cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
  Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.
</p>


</footer>
  


</body>
</html>
