
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="iem7"><![endif]-->
<!--[if lt IE 9]><html class="lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html lang="en"><!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <title>Jake McCrary</title>
    <meta name="author" content="Jake McCrary">

    
    
    
    

    <meta itemprop="name" content="Jake McCrary" />
    <meta itemprop="description" content=" At the beginning of the year I generally take the time to reflect on
my reading in the previous year. I&rsquo;m nearly three months but I&rsquo;m &hellip;" />

    <!-- Twitter Card data -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@jakemcc" />
    <meta name="twitter:title" content="Jake McCrary" />
    <meta name="twitter:description" content=" At the beginning of the year I generally take the time to reflect on
my reading in the previous year. I&rsquo;m nearly three months but I&rsquo;m &hellip;" />
    <meta name="twitter:creator" content="@jakemcc" />
    <meta name="twitter:image" content="https://jakemccrary.com/images/jake-surprised-eyes-brighter.jpg" />

    <!-- Open Graph data -->
    <meta property="og:site_name" content="The Blog of Jake McCrary" />
    <meta property="og:url" content="https://jakemccrary.com/blog/6/" />
    <meta property="og:title" content="Jake McCrary" />
    <meta property="og:description" content=" At the beginning of the year I generally take the time to reflect on
my reading in the previous year. I&rsquo;m nearly three months but I&rsquo;m &hellip;" />
    <meta property="og:image" content="https://jakemccrary.com/images/jake-surprised-eyes-brighter.jpg" />
    
    

    <meta name="description" content=" At the beginning of the year I generally take the time to reflect on
my reading in the previous year. I&rsquo;m nearly three months but I&rsquo;m &hellip;">

    

    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://jakemccrary.com/blog/6/">
    <link href="/favicon.png" rel="icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
    <link href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="alternate" title="Jake McCrary" type="application/atom+xml">
    <link href="https://jakemccrary.com/feed.json" rel="alternate" title="Jake McCrary" type="application/json">

    <!-- iOS scaling bug fix Rewritten version By @mathias, @cheeaun and @jdalton Source url: https://gist.github.com/901295 -->
    <script type="text/javascript">
     (function(doc) {
       var addEvent = 'addEventListener',
           type = 'gesturestart',
           qsa = 'querySelectorAll',
           scales = [1, 1],
           meta = qsa in doc ? doc[qsa]('meta[name=viewport]') : [];
       function fix() {
         meta.content = 'width=device-width,minimum-scale=' + scales[0] + ',maximum-scale=' + scales[1];
         doc.removeEventListener(type, fix, true);
       }
       if ((meta = meta[meta.length - 1]) && addEvent in doc) {
         fix();
         scales = [0.25, 1.6];
         doc[addEvent](type, fix, true);
       }
     }(document));
    </script>
    
<script>
 var origin = window.location.origin;
 if (!origin) {
   origin = window.location.protocol + '//' + window.location.hostname + (window.location.port ? (':' + window.location.port) : '');
 }
 if (origin.indexOf('localhost') === -1) {
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
   })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

   ga('create', 'UA-19834208-2', 'auto');
   ga('send', 'pageview');
 }
</script>


  </head>

<body  >
  <header role="banner"><hgroup>
  <h1><a href="/">Jake McCrary</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul role=main-navigation>
  <li><a href="/">Articles</a></li>
  <li><a href="/adventures/">Adventures</a></li>
  <li><a href="/about.html">About</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="http://feeds.feedburner.com/JakeMccrarysMusings" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  <li><a href="https://jakemccrary.substack.com/welcome" target="_blank" rel="subscribe-email" title="subscribe via email">Newsletter</a></li>
</ul>

  <form action="https://google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="sitesearch" value="jakemccrary.com">
      <input class="search" type="text" name="q" placeholder="Search"/>
    </fieldset>
  </form>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/13/reading-in-2015/">Reading in 2015</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-13T16:18:00-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>4:18 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>At the beginning of the year I generally take the time to reflect on
my reading in the previous year. I&rsquo;m nearly three months but I&rsquo;m
finally taking a look at 2015. Here are my summaries of my
<a href="http://jakemccrary.com/blog/2015/01/08/reading-in-2014/">2014</a> and
<a href="http://jakemccrary.com/blog/2014/01/01/using-incanter-to-review-my-2013-reading/">2013</a>
reading.</p>

<p>I&rsquo;ve continued to keep track of my reading by using
<a href="http://goodreads.com">Goodreads</a>. My
<a href="https://www.goodreads.com/user/show/3431614-jake-mccrary">profile</a>
contains the full list and reviews of books I&rsquo;ve read
since 2010. <a href="https://www.goodreads.com/review/list/3431614-jake-mccrary?read_at=2015">Here</a>
is my 2015 list.</p>

<h3>2015 Goals</h3>

<p>2015 did not have an easily measured goal. I set the vague goal of
increasing the quality of my reading by attempting to think deeper about
what I&rsquo;ve read.</p>

<h3>2015 Results</h3>

<p>I have no idea if I achieved my goal. Some books have stuck with me
and I&rsquo;ve thought quite a bit about the stories. Others I&rsquo;ve forgotten
already.</p>

<p>Looking at raw numbers I read 51 books in 2015 for a total of about
21,790 pages. When compared to 2014 these numbers are lower by 19
books and about 1300 pages.</p>

<p>In terms of star ratings, 2015 was a better year. I had three more
five star books and one more four star book. The 19 book difference
between 2014 and 2015 is entirely found in two and three star books.</p>

<h3>Recommendations</h3>

<p>I awarded ten books a five star rating. This is more five stars than
any other year. Each of the five star books I&rsquo;d recommend without
hesitation. Below is my list of five star books. The titles are
affiliate links to Amazon and the <em>my review</em> text links to
Goodreads.</p>

<ul>
<li><a href="http://amzn.to/24YyEvJ">David Foster Wallace - The Pale King</a> (<a href="https://www.goodreads.com/review/show/882190236">my review</a>)</li>
<li><a href="http://amzn.to/1QPjLV6">Donna Tartt - The Goldfinch</a> (<a href="https://www.goodreads.com/review/show/1168264855">my review</a>)</li>
<li><a href="http://amzn.to/1M0BjhZ">Donna Tartt - The Secret History</a> (<a href="https://www.goodreads.com/review/show/1225842414">my review</a>)</li>
<li><a href="http://amzn.to/1pFcZZg">James Clavell - Shogun</a> (<a href="https://www.goodreads.com/review/show/1284160882">my review</a>)</li>
<li><a href="http://amzn.to/1P6YKAX">John Williams - Stoner</a> (<a href="https://www.goodreads.com/review/show/1152858937">my review</a>)</li>
<li><a href="http://amzn.to/1QPjSA2">Michael L. Anderson - The Rock Climber&rsquo;s Training Manual</a> (<a href="https://www.goodreads.com/review/show/1420673577">my review</a>)</li>
<li><a href="http://amzn.to/1P6YMbY">Neal Stephenson - Cryptonomicon</a> (<a href="https://www.goodreads.com/review/show/799153387">my review</a>)</li>
<li><a href="http://amzn.to/24Yy8xF">Neal Stephenson - Reamde</a> (<a href="https://www.goodreads.com/review/show/927872107">my review</a>)</li>
<li><a href="http://amzn.to/1pFd3bo">Neal Stephenson - Snow Crash</a> (<a href="https://www.goodreads.com/review/show/799153414">my review</a>)</li>
<li><a href="http://amzn.to/1YO1HOf">Sam Newman - Building Microservices</a> (<a href="https://www.goodreads.com/review/show/1202873191">my review</a>)</li>
</ul>


<p>One of the great things about writing this post is that it forces me
to pause and reflect on the previous years books. Its great seeing
this list of great books and remembering the stories. Of these ten
books the ones I remember most fondly are <em>Stoner</em>, <em>Snow Crash</em>, and
<em>The Pale King</em>.</p>

<p>There were also a ton of great four star books this year. One that
stands out is Joseph Heller&rsquo;s
<a href="http://amzn.to/1pFcQFc">Something Happened</a>
(<a href="https://www.goodreads.com/review/show/189671091">my review</a>). Kurt
Vonnegut wrote a brilliant
<a href="http://www.nytimes.com/books/98/02/15/home/heller-something.html">review</a>
of this book which I encourage you to read.</p>

<p>Dave MacLeod&rsquo;s
<a href="http://amzn.to/1pFcVIV">Make or Break: Don&rsquo;t Let Climbing Injuries Dictate Your Success</a>
(<a href="https://www.goodreads.com/review/show/1236422760">my review</a>)
deserves a mention. I highly recommend this book to any climber. We
push our bodies hard and this book will help you prevent and recover
from injuries. I&rsquo;ve used it as a reference so many times over the past
year. It probably deserves five stars.</p>

<h3>Other Stats</h3>

<p>Unsurprisingly, I&rsquo;m continuing to mostly read ebooks.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>|           | 2014 | 2015 |
</span><span class='line'>|-----------+------+------|
</span><span class='line'>| ebook     |   64 |   47 |
</span><span class='line'>| hardcover |    1 |    1 |
</span><span class='line'>| paperback |    4 |    3 |</span></code></pre></td></tr></table></div></figure>


<p>My average rating went up.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>| Year | Average Rating |
</span><span class='line'>|------+----------------|
</span><span class='line'>| 2011 |           3.84 |
</span><span class='line'>| 2012 |           3.66 |
</span><span class='line'>| 2013 |           3.67 |
</span><span class='line'>| 2014 |           3.48 |
</span><span class='line'>| 2015 |           3.86 |</span></code></pre></td></tr></table></div></figure>


<p>Last year I had many repeat authors. This year I had fewer. Neal
Stephenson and Donna Tart really stood out this year. I read multiple
books from both of them and rated every book five stars.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>| Author               | My Average Rating | Number of Pages | Number of books |
</span><span class='line'>|----------------------+-------------------+-----------------+-----------------|
</span><span class='line'>| Neal Stephenson      |                 5 |            2693 |               3 |
</span><span class='line'>| Donna Tartt          |                 5 |            1427 |               2 |
</span><span class='line'>| Paolo Bacigalupi     |       3.666666667 |            1113 |               3 |
</span><span class='line'>| Bret Easton Ellis    |               3.5 |             590 |               2 |</span></code></pre></td></tr></table></div></figure>


<h3>2016 Goals</h3>

<p>In 2016 I&rsquo;m planning on reading one or two biographies. That isn&rsquo;t a
genre I typically read. It should be a pretty easy goal to hit. If you
have any recommendations please leave them in a comment.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/19/clojurescript-treat-warnings-as-errors/">ClojureScript: Treat warnings as errors</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-19T17:09:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>5:09 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Recently my team deployed a new version of our ClojureScript UI and it
had a minor bug. It was trivial to fix the problem, a ClojureScript
build warning pointed us to the cause. As a result we started thinking
it would be nice to have build warnings count as errors and fail our
ClojureScript build.</p>

<p>We use <a href="http://leiningen.org/">Leiningen</a> (version 2.5.3) and
<a href="https://github.com/emezeske/lein-cljsbuild">lein-cljsbuild</a> (version
1.1.1). After some searching we found that lein-cljsbuild supports
<a href="https://github.com/emezeske/lein-cljsbuild#custom-warning-handlers">specifying custom warning handlers</a>
as the value to the <code>:warning-handlers</code> key. The lein-cljsbuild README even
provides an example, which we took and added a <code>(System/exit 1)</code> to
the end of it. This resulted in a build configuration that looked similar to below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:id</span> <span class="s">&quot;prod&quot;</span>
</span><span class='line'> <span class="ss">:warning-handlers</span> <span class="p">[(</span><span class="k">fn </span><span class="p">[</span><span class="nv">warning-type</span> <span class="nv">env</span> <span class="nv">extra</span><span class="p">]</span>
</span><span class='line'>                      <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">s</span> <span class="p">(</span><span class="nf">cljs.analyzer/error-message</span> <span class="nv">warning-type</span> <span class="nv">extra</span><span class="p">)]</span>
</span><span class='line'>                        <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*out*</span> <span class="nv">*err*</span><span class="p">]</span>
</span><span class='line'>                          <span class="p">(</span><span class="nb">println </span><span class="s">&quot;WARNING:&quot;</span> <span class="p">(</span><span class="nf">cljs.analyzer/message</span> <span class="nv">env</span> <span class="nv">s</span><span class="p">)))</span>
</span><span class='line'>                        <span class="p">(</span><span class="nf">System/exit</span> <span class="mi">1</span><span class="p">)))]</span>
</span><span class='line'> <span class="ss">:source-paths</span> <span class="p">[</span><span class="s">&quot;src/cljc&quot;</span> <span class="s">&quot;src/cljs&quot;</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:compiler</span> <span class="p">{</span><span class="ss">:output-to</span> <span class="s">&quot;resources/public/js/compiled/ui.js&quot;</span>
</span><span class='line'>            <span class="ss">:externs</span> <span class="p">[</span><span class="s">&quot;resources/intercom-externs.js&quot;</span>
</span><span class='line'>                      <span class="s">&quot;resources/mixpanel-externs.js&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="ss">:optimizations</span> <span class="ss">:advanced</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This worked! Well, it sort of worked. Our build failed whenever there
was a warning but now we were seeing spurious warnings. We saw &ldquo;Use of
undeclared Var&rdquo; warnings when functions created in a <code>letfn</code> where
calling each other. Definitely not a situation that warrants a warning
and definitely not a build failure.</p>

<p>We weren&rsquo;t seeing this warning before so we opened ClojureScript&rsquo;s
source and found the
<a href="https://github.com/clojure/clojurescript/blob/452edf43927566cc0ea0a3846706c0294cef235d/src/main/clojure/cljs/analyzer.cljc#L360-L366">default warning handler</a>.
The default handler checks that <code>warning-type</code> has a truthy value in
the map <code>*cljs-warnings*</code>. Inspired by the default handler we added
the same check to the start of our warning handler.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="ss">:warning-handlers</span> <span class="p">[(</span><span class="k">fn </span><span class="p">[</span><span class="nv">warning-type</span> <span class="nv">env</span> <span class="nv">extra</span><span class="p">]</span>
</span><span class='line'>                     <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">warning-type</span> <span class="nv">cljs.analyzer/*cljs-warnings*</span><span class="p">)</span>
</span><span class='line'>                       <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">s</span> <span class="p">(</span><span class="nf">cljs.analyzer/error-message</span> <span class="nv">warning-type</span> <span class="nv">extra</span><span class="p">)]</span>
</span><span class='line'>                         <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">*out*</span> <span class="nv">*err*</span><span class="p">]</span>
</span><span class='line'>                           <span class="p">(</span><span class="nb">println </span><span class="s">&quot;WARNING:&quot;</span> <span class="p">(</span><span class="nf">cljs.analyzer/message</span> <span class="nv">env</span> <span class="nv">s</span><span class="p">)))</span>
</span><span class='line'>                         <span class="p">(</span><span class="nf">System/exit</span> <span class="mi">1</span><span class="p">))))]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Success! Now we no longer get incorrect warnings when compiling our
<code>letfn</code> form and our build still fails if a warning occurs. Now we can
build and deploy with a little more confidence.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/18/even-quicker-feedback-from-your-clojure-tests/">Even quicker feedback from your Clojure tests</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-12-18T15:29:00-06:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:29 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>I was recently inspired by a post on a mailing list to make the TDD
cycle with <code>clojure.test</code> and
<a href="https://github.com/jakemcc/lein-test-refresh">lein-test-refresh</a> even
faster. <code>lein-test-refresh</code> is a Leiningen tool that monitors your
Clojure project&rsquo;s source, reloads changes, and then runs your tests.
Tools like it provide some of the fastest feedback cycles possible.</p>

<p>To make the feedback cycle even faster I added the option to only run
tests in changed namespaces. This means you&rsquo;re running
the minimum number of tests after a change. Version 0.12.0 of
<code>lein-test-refresh</code> was released earlier this week with this feature.</p>

<p>To use it add <code>[com.jakemccrary/lein-test-refresh 0.12.0]</code> as a plugin
to your profiles.clj or project.clj. An example
<a href="https://github.com/jakemcc/lein-test-refresh/blob/master/sample.project.clj#L3">project.clj</a>
can be found in the project&rsquo;s GitHub repo.</p>

<p>Once you&rsquo;re on the latest version you can toggle this feature from the
command line by providing a <code>:changes-only</code> flag, <code>lein test-refresh
:changes-only</code>, or by adding <code>:changes-only true</code> to your
<code>:test-refresh</code> configuration section in your project.clj or
profiles.clj. When the feature is on you can still run all your tests
by hitting <code>enter</code> in the terminal running <code>lein test-refresh</code>.</p>

<p>Below is an example of the time difference between running all my tests
and the tests in a single namespace.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Ran 49 tests containing 219 assertions.
</span><span class='line'>0 failures, 0 errors.
</span><span class='line'>
</span><span class='line'>Passed all tests
</span><span class='line'>Finished at 14:42:41.655 (run time: 2.006s)
</span><span class='line'>*********************************************
</span><span class='line'>*************** Running tests ***************
</span><span class='line'>:reloading (lumanu.utils-test)
</span><span class='line'>
</span><span class='line'>Ran 1 tests containing 3 assertions.
</span><span class='line'>0 failures, 0 errors.
</span><span class='line'>
</span><span class='line'>Passed all tests
</span><span class='line'>Finished at 14:43:12.648 (run time: 0.085s)</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve been using this feature for about a week now and am enjoying it.
My whole test suite isn&rsquo;t particularly slow but even still I&rsquo;ve been
enjoying the faster feedback.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/15/sql-aggregate-a-set-of-values-together/">SQL: Aggregate a set of values together</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-11-15T19:45:00-06:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:45 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Lately I&rsquo;ve been working on projects that use
<a href="http://www.postgresql.org/">Postgres</a> as our relational database.
This has allowed us to simplify some of our Clojure code by leaning on
some built-in features of Postgres. One SQL function supported by
Postgres which has greatly simplified our code is the <code>array_agg</code>
<a href="http://www.postgresql.org/docs/9.4/static/functions-aggregate.html">aggregate</a>
function.</p>

<h2>What is <code>array_agg</code>?</h2>

<p>The <code>array_agg</code> function takes an argument and returns an array of the
argument type. That sentence will make more sense after an example.
The snippet below shows a simplified schema for a blog&rsquo;s database.
There is a table called <code>blog_posts</code> that contains details about
posts, a table called <code>categories</code> that has labels that can be applied
to blog posts, and a join table called <code>post_categories</code> that links
the two previous tables together.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">blog</span><span class="o">=#</span> <span class="k">select</span> <span class="n">id</span><span class="p">,</span> <span class="n">title</span> <span class="k">from</span> <span class="n">blog_posts</span><span class="p">;</span>
</span><span class='line'> <span class="n">id</span> <span class="o">|</span>    <span class="n">title</span>
</span><span class='line'><span class="c1">----+--------------</span>
</span><span class='line'>  <span class="mi">1</span> <span class="o">|</span> <span class="k">SQL</span> <span class="n">Post</span>
</span><span class='line'>  <span class="mi">2</span> <span class="o">|</span> <span class="n">Clojure</span> <span class="n">Post</span>
</span><span class='line'>
</span><span class='line'><span class="n">blog</span><span class="o">=#</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">categories</span><span class="p">;</span>
</span><span class='line'> <span class="n">id</span> <span class="o">|</span>   <span class="n">name</span>
</span><span class='line'><span class="c1">----+----------</span>
</span><span class='line'>  <span class="mi">1</span> <span class="o">|</span> <span class="k">sql</span>
</span><span class='line'>  <span class="mi">2</span> <span class="o">|</span> <span class="n">emacs</span>
</span><span class='line'>  <span class="mi">3</span> <span class="o">|</span> <span class="n">clojure</span>
</span><span class='line'>  <span class="mi">4</span> <span class="o">|</span> <span class="n">postgres</span>
</span><span class='line'>
</span><span class='line'><span class="n">blog</span><span class="o">=#</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">post_categories</span><span class="p">;</span>
</span><span class='line'> <span class="n">blog_post_id</span> <span class="o">|</span> <span class="n">category_id</span>
</span><span class='line'><span class="c1">--------------+-------------</span>
</span><span class='line'>            <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span>
</span><span class='line'>            <span class="mi">2</span> <span class="o">|</span>           <span class="mi">2</span>
</span><span class='line'>            <span class="mi">1</span> <span class="o">|</span>           <span class="mi">4</span>
</span><span class='line'>            <span class="mi">2</span> <span class="o">|</span>           <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before I learned about <code>array_agg</code>, if I wanted to know how each blog
post had been categorized I might have written the following query.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="n">name</span> <span class="k">as</span> <span class="n">category</span>
</span><span class='line'>  <span class="k">from</span> <span class="n">blog_posts</span> <span class="n">bp</span>
</span><span class='line'>  <span class="k">join</span> <span class="n">post_categories</span> <span class="n">pc</span> <span class="k">on</span> <span class="n">pc</span><span class="p">.</span><span class="n">blog_post_id</span> <span class="o">=</span> <span class="n">bp</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'>  <span class="k">join</span> <span class="n">categories</span> <span class="k">c</span> <span class="k">on</span> <span class="k">c</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pc</span><span class="p">.</span><span class="n">category_id</span>
</span><span class='line'>  <span class="k">order</span> <span class="k">by</span> <span class="n">title</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">title</span>     <span class="o">|</span> <span class="n">category</span>
</span><span class='line'><span class="c1">--------------+----------</span>
</span><span class='line'> <span class="n">Clojure</span> <span class="n">Post</span> <span class="o">|</span> <span class="n">emacs</span>
</span><span class='line'> <span class="n">Clojure</span> <span class="n">Post</span> <span class="o">|</span> <span class="n">clojure</span>
</span><span class='line'> <span class="k">SQL</span> <span class="n">Post</span>     <span class="o">|</span> <span class="k">sql</span>
</span><span class='line'> <span class="k">SQL</span> <span class="n">Post</span>     <span class="o">|</span> <span class="n">postgres</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is readable but as the number of posts and categories grow
it becomes harder to read. The query also doesn&rsquo;t answer the question,
&ldquo;How are my posts categorized?&rdquo;, well. The ideal answer is a single
row per post that shows the post&rsquo;s categories. You can use <code>array_agg</code>
to get that ideal answer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">select</span> <span class="n">title</span><span class="p">,</span> <span class="n">array_agg</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">categories</span>
</span><span class='line'>  <span class="k">from</span> <span class="n">blog_posts</span> <span class="n">bp</span>
</span><span class='line'>  <span class="k">join</span> <span class="n">post_categories</span> <span class="n">pc</span> <span class="k">on</span> <span class="n">pc</span><span class="p">.</span><span class="n">blog_post_id</span> <span class="o">=</span> <span class="n">bp</span><span class="p">.</span><span class="n">id</span>
</span><span class='line'>  <span class="k">join</span> <span class="n">categories</span> <span class="k">c</span> <span class="k">on</span> <span class="k">c</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">pc</span><span class="p">.</span><span class="n">category_id</span>
</span><span class='line'>  <span class="k">group</span> <span class="k">by</span> <span class="n">title</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">title</span>     <span class="o">|</span>   <span class="n">categories</span>
</span><span class='line'><span class="c1">--------------+-----------------</span>
</span><span class='line'> <span class="k">SQL</span> <span class="n">Post</span>     <span class="o">|</span> <span class="err">{</span><span class="k">sql</span><span class="p">,</span><span class="n">postgres</span><span class="err">}</span>
</span><span class='line'> <span class="n">Clojure</span> <span class="n">Post</span> <span class="o">|</span> <span class="err">{</span><span class="n">emacs</span><span class="p">,</span><span class="n">clojure</span><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I find the <code>array_agg</code> version much nicer to read. The result answers
the question in a very direct fashion and the query expresses the
question well. Everything about the query expresses the question, you
no longer have an extra <code>order by</code> clause to make the result more
readable by human eyes.</p>

<h2>How did it make my Clojure code simpler?</h2>

<p>The above is great and it makes everything more readable for a human.
Most of the time I&rsquo;m not querying a SQL database so that a human can
directly read the results; instead I&rsquo;m using Clojure to manipulate
results of a query. Fortunately, <code>array_agg</code> simplifies my Clojure
code as well.</p>

<p>I&rsquo;m working with a schema that has many relationships similar to the
above relationship. Continuing with the example from above the snippet
below shows the data shape we&rsquo;d get back from <code>clojure.java.jdbc</code>
prior to using <code>array_agg</code>. The data shape we actually want follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; data shape you get from the non-array_agg query.</span>
</span><span class='line'><span class="p">[{</span><span class="ss">:title</span> <span class="s">&quot;Clojure Post&quot;</span> <span class="ss">:category</span> <span class="s">&quot;emacs&quot;</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:title</span> <span class="s">&quot;SQL Post&quot;</span> <span class="ss">:category</span> <span class="s">&quot;sql&quot;</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:title</span> <span class="s">&quot;Clojure Post&quot;</span> <span class="ss">:category</span> <span class="s">&quot;clojure&quot;</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:title</span> <span class="s">&quot;SQL Post&quot;</span> <span class="ss">:category</span> <span class="s">&quot;postgres&quot;</span><span class="p">}]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; data shape you want</span>
</span><span class='line'><span class="p">[{</span><span class="ss">:title</span> <span class="s">&quot;Clojure Post&quot;</span> <span class="ss">:categories</span> <span class="p">[</span><span class="s">&quot;emacs&quot;</span> <span class="s">&quot;clojure&quot;</span><span class="p">]}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:title</span> <span class="s">&quot;SQL Post&quot;</span> <span class="ss">:categories</span> <span class="p">[</span><span class="s">&quot;sql&quot;</span> <span class="s">&quot;postgres&quot;</span><span class="p">]}]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since we&rsquo;re not getting data in our desired shape we need to write
code that combines rows. One way of doing that is to use <code>reduce</code> and <code>map</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">squash-by-title</span> <span class="p">[</span><span class="nv">rows</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">rows</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">r</span> <span class="nv">row</span><span class="p">]</span> <span class="p">(</span><span class="nf">update</span> <span class="nv">r</span> <span class="p">(</span><span class="ss">:title</span> <span class="nv">row</span><span class="p">)</span> <span class="nb">conj </span><span class="p">(</span><span class="ss">:category</span> <span class="nv">row</span><span class="p">)))</span> <span class="p">{})</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">title</span> <span class="nv">categories</span><span class="p">]]</span> <span class="p">{</span><span class="ss">:title</span> <span class="nv">title</span> <span class="ss">:categories</span> <span class="nv">categories</span><span class="p">}))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve been writing Clojure for a long time and when I see code like
above it still takes me a bit of time to figure out what is happening.
Not only that, but eventually your project has different squash
operations depending on what data you&rsquo;re pulling back from the
database. They are probably mostly similar and eventually you abstract
the differences and feel great. Then you come back months later and
have to figure out how it all works. Luckily, if you&rsquo;re using a
database that supports <code>array_agg</code>, there is a better way.</p>

<p>The first step is to change your queries to use <code>array_agg</code>. The
second step is to extend the <code>clojure.java.jdbc/IResultSetReadColumn</code>
protocol to the type returned by your jdbc driver. For my project that
looks like the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; clojure.java.jdbc has been required as jdbc</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">extend-protocol</span> <span class="nv">jdbc/IResultSetReadColumn</span>
</span><span class='line'>  <span class="nv">org.postgresql.jdbc4.Jdbc4Array</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">result-set-read-column</span> <span class="p">[</span><span class="nv">pgobj</span> <span class="nv">metadata</span> <span class="nv">i</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">vec</span> <span class="p">(</span><span class="nf">.getArray</span> <span class="nv">pgobj</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>By changing my queries to use <code>array_agg</code> and adding those four lines
of code I&rsquo;m able to delete all of my squashing functions and get data
from my database in the shape I want. I also end up with easier to
understand code and more expressive queries. Awesome.</p>

<p><em>Thanks to <a href="http://timothypratley.blogspot.com/">Timothy Pratley</a> for
providing feedback on earlier versions of this post.</em></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/03/github-code-reviews/">GitHub Code Reviews</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-07-03T11:22:00-05:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>11:22 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Last December I wrote about the
<a href="/blog/2014/12/09/an-effective-code-review-process/">effective code review process</a>
I started at Outpace. The process works well; participants say it is
the most effective review process they&rsquo;ve experienced. The rest of
this post is a summary of the process with a bit of an enhancement
around setting up the code for review. I&rsquo;d recommend you read the
original
<a href="/blog/2014/12/09/an-effective-code-review-process/">post</a>
for a bit more color on the process.</p>

<h3>Steps for GitHub code review</h3>

<ol>
<li>Select the code to review.</li>
<li>About a week before the review, create a branch and delete the code
you&rsquo;re reviewing.</li>
<li>Push this branch to GitHub and open a pull request. This pull
request provides a location where comments can be made on every
line of code.</li>
<li>Schedule the code review meeting. Make sure participants have two
to three days to asynchronously review the code in the pull
request.</li>
<li>Have the code review. Get everyone together (video chat or in person)
and go through the comments on the pull request and discuss. Add
action items as a comment. The leader of the code review keeps
discussion moving.</li>
</ol>


<p>It&rsquo;s a lightweight process. If you&rsquo;re already using GitHub it doesn&rsquo;t
bring in any other tools and, unlike some dedicated code review
software I&rsquo;ve used, the GitHub pull request interface has good
performance.</p>

<p>One complaint about this process is that the code you&rsquo;re reviewing
appears as deleted in the pull request. It is a superficial complaint
but seeing the entire code base as deleted can feel a bit weird.</p>

<p>For the most recent code review, I figured out how to have all the
code appear as added. The snippet below contains the steps and example
commands.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">#</span> <span class="nb">cd </span>to the repository you are reviewing.
</span><span class='line'><span class="go">cd blog</span>
</span><span class='line'>
</span><span class='line'><span class="gp">#</span> Make a new branch.
</span><span class='line'><span class="go">git checkout -b empty-repo</span>
</span><span class='line'>
</span><span class='line'><span class="gp">#</span> Copy all files in repo to a temporary directory.
</span><span class='line'><span class="go">rm -rf /tmp/repo &amp;&amp; mkdir /tmp/repo &amp;&amp; cp -R * /tmp/repo</span>
</span><span class='line'>
</span><span class='line'><span class="gp">#</span> Remove all files from repository, commit, and push to GitHub.
</span><span class='line'><span class="go">rm -rf *</span>
</span><span class='line'><span class="go">git commit -am &#39;remove all files&#39;</span>
</span><span class='line'><span class="go">git push origin empty-repo</span>
</span><span class='line'>
</span><span class='line'><span class="gp">#</span> Create a new branch with the empty-repo as the parent.
</span><span class='line'><span class="go">git checkout -b code-review</span>
</span><span class='line'>
</span><span class='line'><span class="gp">#</span> Copy back in the files and add the files you want to review.
</span><span class='line'><span class="gp">#</span> Commit and push to GitHub.
</span><span class='line'><span class="go">cp -R /tmp/repo/* .</span>
</span><span class='line'><span class="go">git add files-to-review</span>
</span><span class='line'><span class="go">git commit -m &#39;adding files for review&#39;</span>
</span><span class='line'><span class="go">git push origin code-review</span>
</span><span class='line'>
</span><span class='line'><span class="gp">#</span> Now, go to project on GitHub and switch to the code-review branch.
</span><span class='line'><span class="gp">#</span> Open a pull request comparing the empty-repo and the code-review
</span><span class='line'><span class="gp">#</span> branch.
</span></code></pre></td></tr></table></div></figure>


<p>Voila, you now have a pull request with every line under review marked
as added instead of deleted! It takes a little more than two times the
number steps required to open a pull request with the code deleted but
you might find it worth it. Seeing code as added instead of removed is
a minor thing but minor things can make a process more enjoyable. It
is nice to know it is possible.</p>

<p>If you aren&rsquo;t doing code reviews or have found them useless in the
past, I recommend you try out this process. This post is the
abbreviated version but it gives you enough to get started. If you
haven&rsquo;t done one in this style before, I&rsquo;d highly recommend reading
the longer <a href="/blog/2014/12/09/an-effective-code-review-process/">post</a>
as it gives some details that I&rsquo;ve left out here.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/30/my-favorite-clj-refactor-features/">My favorite clj-refactor features</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-30T08:40:00-05:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:40 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>If you write Clojure using Emacs you should check out
<a href="https://github.com/clojure-emacs/clj-refactor.el">clj-refactor</a>. It
is working better than ever and makes developing Clojure more
enjoyable.</p>

<p>I don&rsquo;t use all the features in clj-refactor. There are a lot of
features I haven&rsquo;t had the need to use and many I just can&rsquo;t remember.
Below are the features I use consistently.</p>

<h3>Favorite Features</h3>

<p>My favorite feature of clj-refactor is the
<a href="/blog/2015/06/18/emacs-automatically-require-common-namespaces/">magic requires</a>.
This feature lets you type a prefix (such as <code>(str/)</code>) and have the
namespace automatically added to your <code>ns</code> form (in this example
<code>[clojure.string :as str]</code>). It is awesome. You can also add
<a href="/blog/2015/06/18/emacs-automatically-require-common-namespaces/">your own</a>
prefix mappings.</p>

<p>My other most frequently used refactorings are
<a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-introduce-let">introduce let</a>,
<a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-expand-let">expand let</a>,
and
<a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-move-to-let">move to let</a>.
These three are very complementary and are a quick way if introducing
named locals.</p>

<p><a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-add-missing-libspec">Add missing libspec</a>
is a recent discovery of mine. Have you ever paired with a developer
who uses Intellij with Cursive and been a bit jealous of the
auto-requiring? I have. This refactoring lets you do that. Type
whatever symbol you want and clj-refactor tries to resolve it and then
require the containing namespace with correct prefix. Recently I broke
a massive namespace into a few smaller ones and this refactoring saved
me a ton of time.</p>

<p>I used to use
<a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-move-form">move form</a>
when trying to reorganize namespaces but now I pretty much just cut
and paste and use
<a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-add-missing-libspec">add missing libspec</a>
to fix the requires. I want to use <strong>move form</strong> but I haven&rsquo;t had a
ton of success with it. <strong>Add missing libspec</strong> plus cut and paste is
a few more steps but my success rate has been much higher.</p>

<p><a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-sort-ns">Sort ns</a>
does exactly what it says, it sorts your <code>ns</code> form. Once you get used
to keeping your <code>ns</code> forms sorted you won&rsquo;t go back.</p>

<p><a href="https://github.com/clojure-emacs/clj-refactor.el/wiki/cljr-extract-function">Extract function</a>
is another refactoring I recently stumbled upon. I&rsquo;ve used it a few
times since then and when it works it is pretty awesome. I&rsquo;ve had
unexpected behavior a couple of times but it was unclear if that was
my fault or it not handling macros well. If you&rsquo;re extracting a
function you might as well give it a shot.</p>

<p>The final feature is the
<a href="https://github.com/clojure-emacs/clj-refactor.el/wiki#automatic-insertion-of-namespace-declaration">automatic insertion of namespace declarations</a>
when you create a new Clojure file. I nearly forgot to highlight this
feature because it requires no action on my side and it is amazing. If
I never have to type a namespace symbol again I&rsquo;ll be happy.</p>

<h3>Customization</h3>

<p>Below is my entire clj-refactor setup from my Emacs init.el. It
doesn&rsquo;t take much to get it to a state I like.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='elisp'><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;clj-refactor</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Add custom magic requires.</span>
</span><span class='line'><span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">mapping</span> <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;maps&quot;</span> <span class="o">.</span> <span class="s">&quot;outpace.util.maps&quot;</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="s">&quot;seqs&quot;</span> <span class="o">.</span> <span class="s">&quot;outpace.util.seqs&quot;</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="s">&quot;times&quot;</span> <span class="o">.</span> <span class="s">&quot;outpace.util.times&quot;</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="s">&quot;repl&quot;</span> <span class="o">.</span> <span class="s">&quot;outpace.util.repl&quot;</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="s">&quot;time&quot;</span> <span class="o">.</span> <span class="s">&quot;clj-time.core&quot;</span><span class="p">)</span>
</span><span class='line'>                   <span class="p">(</span><span class="s">&quot;string&quot;</span> <span class="o">.</span> <span class="s">&quot;clojure.string&quot;</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">add-to-list</span> <span class="ss">&#39;cljr-magic-require-namespaces</span> <span class="nv">mapping</span> <span class="no">t</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">setq</span> <span class="nv">cljr-favor-prefix-notation</span> <span class="no">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;clojure-mode-hook</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
</span><span class='line'>                               <span class="p">(</span><span class="nv">clj-refactor-mode</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                               <span class="p">(</span><span class="nv">yas/minor-mode</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                               <span class="p">(</span><span class="nv">cljr-add-keybindings-with-prefix</span> <span class="s">&quot;C-c C-x&quot;</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you use Emacs and write Clojure you should check out clj-refactor.
There are enough features that consistently work and help keep you in
the flow that it is worth using.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/18/emacs-automatically-require-common-namespaces/">Emacs: automatically require common namespaces</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T12:52:00-05:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>12:52 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;re writing Clojure in Emacs you should check out
<a href="https://github.com/clojure-emacs/clj-refactor.el">clj-refactor</a>. It
provides some neat functionality. Some examples include the ability to
extract functions, introduce <code>let</code> forms, and inline symbols. It also
has a feature called &ldquo;magic requires&rdquo; that automatically requires
common namespaces when you type their short form.</p>

<p>Out of the box five short forms are supported. They are <code>io</code> for
<code>clojure.java.io</code>, <code>set</code> for <code>clojure.set</code>, <code>str</code> for
<code>clojure.string</code>, <code>walk</code> for <code>clojure.walk</code>, and <code>zip</code> for
<code>clojure.zip</code>. If you type <code>(str/</code> then <code>(:require
[clojure.string :as str])</code> will be added to your <code>ns</code> form. It is
pretty awesome. This feature is on by default but you can turn it off
by adding <code>(setq cljr-magic-requires nil)</code> to your Emacs
configuration.</p>

<p>This feature is also extensible. You can add your own mappings of
short form to namespace. The following snippet of elisp adds mappings
for <code>maps</code>, <code>seqs</code>, and <code>string</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(dolist (mapping '(("maps" . "outpace.util.maps")
</span><span class='line'>                   ("seqs" . "outpace.util.seqs")
</span><span class='line'>                   ("string" . "clojure.string")))
</span><span class='line'>  (add-to-list 'cljr-magic-require-namespaces mapping t))</span></code></pre></td></tr></table></div></figure>


<p>It doesn&rsquo;t take a lot of code but having it is awesome. If there are
namespaces you frequently require I highly recommend setting this up.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/31/use-git-pre-commit-hooks-to-stop-unwanted-commits/">Use git pre-commit hooks to stop unwanted commits</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-31T11:51:00-05:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>11:51 am</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you&rsquo;ll make a change to some code and not want to commit it.
You probably add a comment to the code and hope you&rsquo;ll either see the
comment in the diff before committing or just remember not to check in
the change. If you&rsquo;ve ever done this you&rsquo;ve probably also committed
something you didn&rsquo;t mean to commit. I know I have.</p>

<p>Luckily we can do better. Using git pre-commit
<a href="https://git-scm.com/docs/githooks">hooks</a> we can make git stop us
from committing. Below is a git pre-commit hook that searches for the
text <em>nocommit</em> and if found rejects the commit. With it you can
stick <em>nocommit</em> in a comment next to the change you don&rsquo;t want
committed and know that it won&rsquo;t be committed.</p>

<h3>The code</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If you use a GUI for controlling git, you might want to comment out the `tput` commands.</span>
</span><span class='line'><span class="c"># Some users have had problems with those commands and whatever GUI they are using.</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> git rev-parse --verify HEAD &gt;/dev/null 2&gt;<span class="p">&amp;</span>1
</span><span class='line'><span class="k">then</span>
</span><span class='line'>    <span class="nv">against</span><span class="o">=</span>HEAD
</span><span class='line'><span class="k">else</span>
</span><span class='line'>    <span class="c"># Initial commit: diff against an empty tree object</span>
</span><span class='line'>    <span class="nv">against</span><span class="o">=</span><span class="k">$(</span>git <span class="nb">hash</span>-object -t tree /dev/null<span class="k">)</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">patch_filename</span><span class="o">=</span><span class="k">$(</span>mktemp -t commit_hook_changes.XXXXXXX<span class="k">)</span>
</span><span class='line'>git diff --exit-code --binary --ignore-submodules --no-color &gt; <span class="s2">&quot;$patch_filename&quot;</span>
</span><span class='line'><span class="nv">has_unstaged_changes</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$has_unstaged_changes</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    <span class="c"># Unstaged changes have been found</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;$patch_filename&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Failed to create a patch file&quot;</span>
</span><span class='line'>        <span class="nb">exit </span>1
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Stashing unstaged changes in $patch_filename.&quot;</span>
</span><span class='line'>        git checkout -- .
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>quit<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="nv">$has_unstaged_changes</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        git apply <span class="s2">&quot;$patch_filename&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>            git checkout -- .
</span><span class='line'>            git apply --whitespace<span class="o">=</span>nowarn --ignore-whitespace <span class="s2">&quot;$patch_filename&quot;</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">exit</span> <span class="nv">$1</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Redirect output to stderr.</span>
</span><span class='line'><span class="nb">exec </span>1&gt;<span class="p">&amp;</span>2
</span><span class='line'>
</span><span class='line'><span class="nv">files_with_nocommit</span><span class="o">=</span><span class="k">$(</span>git diff --cached --name-only --diff-filter<span class="o">=</span>ACM <span class="nv">$against</span> <span class="p">|</span> xargs -I<span class="o">{}</span> grep -i <span class="s2">&quot;nocommit&quot;</span> -l <span class="o">{}</span> <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39; &#39;</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;x${files_with_nocommit}x&quot;</span> !<span class="o">=</span> <span class="s2">&quot;xx&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>    tput setaf 1
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;File being committed with &#39;nocommit&#39; in it:&quot;</span>
</span><span class='line'>    <span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
</span><span class='line'>    <span class="k">for</span> f in <span class="k">$(</span>git diff --cached --name-only --diff-filter<span class="o">=</span>ACM <span class="nv">$against</span> <span class="p">|</span> xargs -I<span class="o">{}</span> grep -i <span class="s2">&quot;nocommit&quot;</span> -l <span class="o">{}</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="nv">$f</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'>    tput sgr0
</span><span class='line'>    quit 1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>quit 0
</span></code></pre></td></tr></table></div></figure>


<p>Lines 3-10 figure out what revision to diff against. They can pretty
much be ignored.</p>

<p>Lines 11-30 are all about handling unstaged changes. They create a
patch with these changes and revert these changes from the repository.
Then, in the function <code>quit</code>, the unstaged changes are reapplied to
the repository. All of this is done so that <em>nocommit</em> in a
un-committed piece of text doesn&rsquo;t cause the committed changes to be
rejected.</p>

<p>Some online guides suggest using <code>git stash</code> to achieve what is
described above. I started out using <code>git stash</code> but ran into problems
where I&rsquo;d end up in weird states. Unfortunately I didn&rsquo;t take good
notes and I&rsquo;m unable to describe the various bad things that happened.
Trust me when I say bad things did happen and that this way (create
patch, revert, apply patch) is much more successful.</p>

<p>Line 36 figures out what files contain <em>nocommit</em>. Lines 38-44 report
what files contain <em>nocommit</em> and then rejects the commit by exiting
with a non-zero exit code. The first <code>tput</code> changes the output of the
<code>echo</code> commands to colored red and the second <code>tput</code> changes output
back to default.</p>

<blockquote><p>Warning: I know many developers that love using this and have had no problems. I get the occasional report of it not working. If it doesn&rsquo;t work, and it seems like you&rsquo;ve lost changes, you can find the patch file wherever mktemp creates files on your local machine. I&rsquo;d still recommend testing it out on a small changeset so if something doesn&rsquo;t work on your machine you don&rsquo;t have to both debug why and recreate your changes.</p></blockquote>

<h3>Using with a single repository</h3>

<p>To enable in a single repository you need to add the above code to a
<code>.git/hooks/pre-commit</code> file in your local repository and make that
file executable. Once you&rsquo;ve done that try adding <em>nocommit</em> to a file
and then try to commit it. The commit will be rejected if the
pre-commit hook is setup properly.</p>

<h3>Using with multiple repositories</h3>

<p>I want this pre-commit hook enabled in all of my repositories. I use
git init templates to do this. <code>git help init</code> or a
Google search can help fill in the gaps with setting this up but below
are the steps I ended up taking.</p>

<ol>
<li><code>git config --global init.templatedir ~/.git-templates</code></li>
<li><code>mkdir -p ~/.git-templates/hooks</code></li>
<li><code>touch ~/.git-templates/hooks/pre-commit</code></li>
<li>Copy and paste the above code into
<code>~/.git-templates/hooks/pre-commit</code></li>
<li><code>chmod +x ~/.git-templates/hooks/pre-commit</code></li>
</ol>


<p>After following those steps any repository created by <code>git init</code> will
contain the pre-commit hook. To add to an existing repository <code>cd</code> into
the repo and run  <code>git init .</code>.</p>

<h3>Example output</h3>

<p>If you try to commit some text with <em>nocommit</em> in it you&rsquo;ll see
something similar to the image below and the commit will be rejected.</p>

<p><img src="/images/pre-commit-example.png" alt="Error message" /></p>

<p>If you ever need to commit and want to ignore pre-commit hooks
(example: If you are writing a blog post that is full of the text
<em>nocommit</em>) then you can ignore pre-commit hooks by using <code>git commit
--no-verify</code>.</p>

<p>I&rsquo;ve found this pre-commit hook really useful. It has saved me from
committing numerous times. I&rsquo;d recommend adopting it.</p>

<h2>Errata</h2>

<p><em>2015/12/23</em></p>

<p>I&rsquo;m updated the code to be more portable. It was brought to my
attention by a comment that the original code took advantage of some
bash extensions and specific <code>mktemp</code> behavior found in OS X. The
pre-commit code has now been tested works in OS X and Ubuntu 14.04.
There may be minor changes you need to perform to get it to work on
your system.</p>

<p><em>2017/04/28</em></p>

<p>Updated code to handle if <code>mktemp</code> fails and if whitespace changes
between creating a patch and applying it. Also adds in a change that
better handles whitespace in paths.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/03/put-the-last-commands-run-time-in-your-bash-prompt/">Put the last command's run time in your Bash prompt</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-03T20:37:00-05:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>8:37 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>An updated version of this post can be found <a href="/blog/2020/04/21/using-bash-preexec-for-monitoring-the-runtime-of-your-last-command/">here</a></p></blockquote>

<p>I&rsquo;m fairly certain the following scenario has happened to every
terminal user. You run a command and, while it is running, realize you
should have prefixed it with <a href="http://linux.die.net/man/1/time"><code>time</code></a>. You
momentarily struggle with the thought of killing the command and
rerunning it with <code>time</code>. You decide not to and the command finishes
without you knowing how long it took. You debate running it again.</p>

<p>For the last year I&rsquo;ve lived in a world without this problem. Upon
completion, a command&rsquo;s approximate run time is displayed in my
prompt. It is awesome.</p>

<h2>Overview</h2>

<p>Most of the code below is from a post on
<a href="http://stackoverflow.com/a/1862762/491871">Stack Overflow</a>. It has
been slightly modified to support having multiple commands in your
<code>$PROMPT_COMMAND</code> variable. Below is a minimal snippet that could be
included in your <code>.bashrc</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="k">function</span> timer_start <span class="o">{</span>
</span><span class='line'>  <span class="nv">timer</span><span class="o">=</span><span class="k">${</span><span class="nv">timer</span><span class="k">:-</span><span class="nv">$SECONDS</span><span class="k">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> timer_stop <span class="o">{</span>
</span><span class='line'>  <span class="nv">timer_show</span><span class="o">=</span><span class="k">$((</span><span class="nv">$SECONDS</span> <span class="o">-</span> <span class="nv">$timer</span><span class="k">))</span>
</span><span class='line'>  <span class="nb">unset </span>timer
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">trap</span> <span class="s1">&#39;timer_start&#39;</span> DEBUG
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$PROMPT_COMMAND&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">&quot;timer_stop&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">&quot;$PROMPT_COMMAND; timer_stop&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">PS1</span><span class="o">=</span><span class="s1">&#39;[last: ${timer_show}s][\w]$ &#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Modify your <code>.bashrc</code> to include the above and you&rsquo;ll have a prompt
that looks like the image below. It is a minimal prompt but it
includes the time spent on the last command. This is great. No more
wondering how long a command took.</p>

<p><img src="/images/prompt-timings.png" alt="Example of prompt" /></p>

<h2>The details</h2>

<p><code>timer_start</code> is a function that sets <code>timer</code> to be its current value
or, if <code>timer</code> is unset, sets it to the value of <code>$SECONDS</code>.
<code>$SECONDS</code> is a special variable that contains the number of seconds
since the shell was started. <code>timer_start</code> is invoked after every
simple command as a result of <code>trap 'timer_start' DEBUG</code>.</p>

<p><code>timer_stop</code> calculates the difference between <code>$SECONDS</code> and <code>timer</code>
and stores it in <code>timer_show</code>. It also unsets <code>timer</code>. Next time
<code>timer_start</code> is invoked <code>timer</code> will be set to the current value of
<code>$SECONDS</code>. Because <code>timer_stop</code> is part of the <code>$PROMPT_COMMAND</code> it
is executed prior to the prompt being printed.</p>

<p>It is the interaction between <code>timer_start</code> and <code>timer_stop</code> that
captures the run time of commands. It is important that <code>timer_stop</code>
is the <strong>last</strong> command in the <code>$PROMPT_COMMAND</code>. If there are other
commands after it then those will be executed and their execution
might cause <code>timer_start</code> to be called. This results in you timing the
length of time between the prior and current prompts being printed.</p>

<h2>My prompt</h2>

<p>My prompt is a bit more complicated. It shows the last exit code, last
run time, time of day, directory, and git information. The run time of
the last command is one of the more useful parts of my prompt. I
highly recommend you add it to yours.</p>

<p><img src="/images/my-prompt.png" alt="My prompt" /></p>

<h2>Errata</h2>

<p><em>2015/5/04</em></p>

<p><a href="https://twitter.com/gfredericks_">Gary Fredericks</a> noticed that the
original code sample broke if you didn&rsquo;t already have something set as
your <code>$PROMPT_COMMAND</code>. I&rsquo;ve updated the original snippet to reflect
his <a href="https://twitter.com/gfredericks_/status/595249998838800384">changes</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/25/quieter-clojure-dot-test-output/">Quieter clojure.test output</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-25T15:40:00-05:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>3:40 pm</span></time>
      </p>
    
  </header>


  <div class="entry-content"><p>If you use <code>clojure.test</code> then there is a good chance you&rsquo;ve been
annoyed by all the
<a href="https://github.com/jakemcc/lein-test-refresh/issues/33">output</a> when
you run your tests in the terminal. When there is a test failure you
have to scroll through pages of output to find the error.</p>

<p>With release <code>0.9.0</code> of
<a href="https://github.com/jakemcc/lein-test-refresh">lein-test-refresh</a> you
can minimize the output of <code>clojure.test</code> and <strong>only</strong> see failure and
summary messages. To enable this feature add <code>:quiet true</code> to the
<code>:test-refresh</code> configuration map in either your project.clj or
profiles.clj file. If you configure <code>lein-test-refresh</code> in
<code>~/.lein/profiles.clj</code> then turning on this feature looks like the
following. <sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:user</span> <span class="p">{</span><span class="ss">:plugins</span> <span class="p">[[</span><span class="nv">com.jakemccrary/lein-test-refresh</span> <span class="s">&quot;0.9.0&quot;</span><span class="p">]]</span>
</span><span class='line'>        <span class="ss">:test-refresh</span> <span class="p">{</span><span class="ss">:quiet</span> <span class="nv">true</span><span class="p">}}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Setting up your profiles.clj like above allows you to move to Clojure
project in your terminal, run <code>lein test-refresh</code>, and have your
<code>clojure.test</code>s run whenever a file changes. In addition, your
terminal won&rsquo;t show the usual <em>Testing a.namespace</em> output.</p>

<p>Below is what you typically see when running <code>clojure.test</code> tests in a
terminal. I had to cut most of the <em>Testing a.namespace</em> messages from
the picture.</p>

<p><img src="/images/not-quiet-test-output.png" alt="Normal view of test output" /></p>

<p>The following picture is with quiet mode turned on in
<code>lein-test-refresh</code>. No more <em>Testing a.namespace</em> messages! No more
scrolling through all your namespaces to find the failure!</p>

<p><img src="/images/minimal-test-output.png" alt="Minimal output in console" /></p>

<p>I just released this feature so i haven&rsquo;t had a chance to use it too
much. I imagine it may evolve to change the output more.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>More configuration options can be found <a href="https://github.com/jakemcc/lein-test-refresh/blob/master/sample.project.clj#L5-L24">here</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog//7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog//5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/05/04/how-to-be-alerted-when-a-long-running-process-finishes/">How to be automatically notified when long running processes finish</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/26/hanging-a-hangboard-using-a-doorway-pull-up-bar/">How to hang a hangboard using a doorway pull-up bar</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/21/using-bash-preexec-for-monitoring-the-runtime-of-your-last-command/">Using Bash-Preexec for monitoring the runtime of your last command</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/03/16/a-retrospective-format/">A retrospective format for remote or co-located teams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/03/10/more-working-from-home-tips/">More working from home tips</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/25/auto-syncing-a-git-repository/">Auto-syncing a git repository</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/11/reading-in-2019/">Reading in 2019</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/12/building-an-atreus-keyboard/">Building an Atreus keyboard</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/23/building-a-onewheel-stand/">Building a Onewheel stand</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/08/15/switching-my-ergodox-to-qmk-firmware/">Switching my Ergodox to QMK firmware</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Subscribe</h1>
  <p>Looking forward to reading more of my writing?</p>
  <p>Sign up for my <a target="_blank" href="https://jakemccrary.substack.com/welcome">newsletter</a> to get periodic emails with links to my latest writing and other thoughts.</p>
  <p>Can't wait for the infrequent newsletter? Subscribe to the <a href="http://feeds.feedburner.com/JakeMccrarysMusings">RSS</a> feed.</p>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <a href="/disclosure-policy">Disclosure Policy</a><br/>
  <a href="//www.iubenda.com/privacy-policy/509351" class="iubenda-nostyle iub-legal-only iubenda-embed" title="Privacy Policy">Privacy Policy</a><br/>
<script type="text/javascript">(function (w,d) {var loader = function () {var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0]; s.src = "//cdn.iubenda.com/iubenda.js"; tag.parentNode.insertBefore(s,tag);}; if(w.addEventListener){w.addEventListener("load", loader, false);}else if(w.attachEvent){w.attachEvent("onload", loader);}else{w.onload = loader;}})(window, document);</script>
  Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.
</p>


</footer>
  


</body>
</html>
